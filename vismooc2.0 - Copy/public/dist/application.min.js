"use strict";function AnimationCtrl($scope,pubsubService,dataManagerService){$scope.courseInfo=-1,$scope.aside={title:"Title",content:"Hello Aside<br />This is a multiline message!"},pubsubService.onChangeCourse($scope,function(courseID){courseID>=0&&dataManagerService.getCourseInfo(courseID,function(data){$scope.courseInfo=data})})}function contentBasedCtrl($scope,pubsubService,dataManagerService,$sce){function setData(videoID,filter){filter?filter.country?(dataManagerService.getActionCountInfoByCountry($scope.selectedCourseId,videoID,filter.country,processData),dataManagerService.getSeekInfoByCountry($scope.selectedCourseId,videoID,filter.country,processSeekData)):filter.period&&(dataManagerService.getActionCountInfoByTime($scope.selectedCourseId,videoID,filter.period.startDate,filter.period.endDate,processData),dataManagerService.getSeekInfoByTime($scope.selectedCourseId,videoID,filter.period.startDate,filter.period.endDate,$scope.passDataToController)):(dataManagerService.getActionCountInfo($scope.selectedCourseId,videoID,processData),dataManagerService.getSeekInfo($scope.selectedCourseId,videoID,processSeekData))}console.log($("#viscontent").innerWidth()),console.log($("#viscontent").width()),$scope.config={preload:"none",sources:[{src:$sce.trustAsResourceUrl("http://static.videogular.com/assets/videos/videogular.mp4"),type:"video/mp4"},{src:$sce.trustAsResourceUrl("http://static.videogular.com/assets/videos/videogular.webm"),type:"video/webm"},{src:$sce.trustAsResourceUrl("http://static.videogular.com/assets/videos/videogular.ogg"),type:"video/ogg"}],theme:{url:"lib/videogular-themes-default/videogular.css"},width:$("#viscontent").width(),height:500,plugins:{controls:{autoHide:!0,autoHideTime:2e3}}},$scope.onUpdateTime=function($currentTime,$duration){$scope.$apply(function(){var percentage=$currentTime/$duration*100;$("#timeProgressBar").css("width",percentage+"%")})},$scope.multiChartOptions={chart:{type:"stackedAreaChart",height:300,margin:{top:20,right:0,bottom:60,left:80},x:function(d){return d.x},y:function(d){return d.y},useVoronoi:!1,clipEdge:!0,transitionDuration:500,useInteractiveGuideline:!0,xAxis:{showMaxMin:!1,tickFormat:function(d){var sec=d%60,min=Math.floor(d/60);return 0===sec&&(sec="00"),d3.time.format(min+"'"+sec+'"')}},yAxis:{tickFormat:function(d){return d}},fireClickEvent:function(e){$scope.currentTime=e.pointXValue,console.log($("#video")),$("#video")[0].childNodes[0].currentTime=Math.floor($scope.currentTime*($("#video")[0].childNodes[0].duration-5)/$("#video")[0].childNodes[0].duration+2)}}},$scope.currentTime=0,$scope.durationTime=0,$scope.selectedCourseId=-1,$scope.videoID=-1,$scope.period={},$scope.country="",$scope.selectedFreq=0,$scope.videoSrc="",pubsubService.onChangeVideo($scope,function(videoInfo){videoInfo&&($scope.videoSrc=videoInfo.videoSource,$scope.videoID=videoInfo.videoId,$scope.currentTime=0,$scope.config.sources=[{src:$sce.trustAsResourceUrl(videoInfo.videoSource),type:"video/mp4"},{src:$sce.trustAsResourceUrl(videoInfo.videoSource),type:"video/webm"},{src:$sce.trustAsResourceUrl(videoInfo.videoSource),type:"video/ogg"}],setData(videoInfo.videoId))}),pubsubService.onFilterCountry($scope,function(countryID){countryID&&($scope.country=countryID,setData($scope.videoID,{country:countryID}))}),pubsubService.onFilterDate($scope,function(period){period&&($scope.period=period,setData($scope.videoID,{period:period}))}),pubsubService.onChangeCourse($scope,function(courseID){courseID&&($scope.selectedCourseId=courseID)}),$scope.IntroOptions={steps:[{element:"#seekline_id",intro:"Orange lines are forward seeks, which show that users            skip certain part of the video, while blue lines are backward seeks,             which mean that users review some part of the video."},{element:"#stacked_id",intro:"The stacked bar chart shows the number of actions per second of the video.             X-axis indicates the position corresponding to the video, while Y-axis displays the number of actions.            Different colors indicate different kinds of actions.",position:"top"}],showStepNumbers:!1,exitOnOverlayClick:!0,exitOnEsc:!0,nextLabel:"<strong>NEXT!</strong>",prevLabel:'<span style="color:green">Previous</span>',skipLabel:"Exit",doneLabel:"Thanks"},$scope.ShouldAutoStart=function(){return!0},$scope.count=0,$scope.showTooltip=function(){console.log("called show tooltip"),$scope.count>0||($scope.CallMe(),$scope.count++)};var processData=function(data){data.clicks&&($scope.multiChartdata=data.clicks.map(function(dat){var length=dat.data.length,result=dat.data.slice(3,length-3).aggregate(3).map(function(dd,i){return{x:3*i,y:Math.floor(dd)}});return{key:dat.type,values:result,color:colors(dat.type)}}))},getWeeks=function(seekData){for(var ret={},i=0,len=seekData.length;len>i;i++){var tempKey=""+seekData[i].week;ret.hasOwnProperty(tempKey)?ret[tempKey]++:ret[tempKey]=1}return ret},processSeekData=function(data){var barHeight=40,barMargin=10;$scope.seekData=data,$scope.mouseCount++,$scope.videoLength=d3.max(data,function(d){return d.prevTime});var weeks=getWeeks($scope.seekData);$scope.weeks=weeks;var textHeight=Object.keys(weeks).length;$scope.dynamicHeight=2*(barHeight+barMargin)*textHeight};$scope.passDataToController=function(touse){$scope.seekDataPart=touse,console.log("enter sender function"),$scope.$apply()};$scope.addMouseDown=function(){$scope.isMouseOn=!1,console.log("mouse down")},$scope.mouseCount=0,$scope.addMouseUp=function(){$scope.mouseCount++,$scope.isMouseOn=!0,console.log("mouse up")},$scope.threshold=30}function courseInfoCtrl($scope,pubsubService,dataManagerService){$scope.courseInfo=-1,pubsubService.onChangeCourse($scope,function(courseID){courseID>=0&&dataManagerService.getCourseInfo(courseID,function(data){$scope.courseInfo=data})})}function forumSocialNetwork($scope,pubsubService,dataManagerService,pip){$scope.courseID=-1,$scope.option={width:1200,height:600},$scope.threshold={value:3},$scope.showInfo="No selection",pubsubService.onChangeCourse($scope,function(courseID){if(courseID>=0){$scope.courseID=courseID;var threshold=$scope.threshold;dataManagerService.getForumSocialNetwork(courseID,threshold.value,function(data){$scope.datacopy=data,$scope.data=data}),dataManagerService.getDemographicData($scope.courseID,function(data){$scope.geodata=data})}}),pip.onGraphUsername($scope,function(data){var userId=data[0],username=data[1];$scope.showInfo="Selected user: "+username,dataManagerService.getWordCloudData($scope.courseID,userId,function(data){$scope.wordCloudData=data})}),$scope.clearSelection=function(){console.log("enter clear"),$scope.wordCloudData=[],$scope.showInfo="No selection",$scope.countrycode="-"},$scope.countrycode="",pip.onCode3($scope,function(data){$scope.$apply(function(){$scope.countrycode=data,$scope.showInfo="Selected country: "+data}),dataManagerService.getWordCloudDataByGeo($scope.courseID,$scope.countrycode,function(data){$scope.wordCloudData=data})}),$scope.changeThreshold=function(){console.log($scope.threshold.value),dataManagerService.getForumSocialNetwork($scope.courseID,$scope.threshold.value,function(data){console.log("data changed"),console.log($scope),$scope.data=data,$scope.datacopy=data})},$scope.IntroOptions={steps:[{element:"#graph_id",intro:"This graph diagram shows how users interact with each other in the forum.            ",position:"left"}],showStepNumbers:!1,exitOnOverlayClick:!0,exitOnEsc:!0,nextLabel:"<strong>NEXT!</strong>",prevLabel:'<span style="color:green">Previous</span>',skipLabel:"Exit",doneLabel:"Thanks"},$scope.count=0,$scope.showTooltip=function(){$scope.count>0||($scope.CallMe(),$scope.count++)}}function geographicInfoCtrl($scope,pubsubService,dataManagerService){$scope.demographicInfo=-1,pubsubService.onChangeCourse($scope,function(courseID){courseID&&dataManagerService.getDemographicData(courseID,function(data){$scope.demographicInfo=data})}),$scope.filterByCountry=function(countryID){pubsubService.filterCountry(countryID)},$scope.IntroOptions={steps:[{element:"#step4",intro:"User distribution is shown here demographically. You can click each country to             filter users and it will affect the seek diagram and event graph.",position:"left"}],showStepNumbers:!1,exitOnOverlayClick:!0,exitOnEsc:!0,nextLabel:"<strong>NEXT!</strong>",prevLabel:'<span style="color:green">Previous</span>',skipLabel:"Exit",doneLabel:"Thanks"},$scope.ShouldAutoStart=function(){return!0},$scope.count=0,$scope.showTooltip=function(){console.log("called show tooltip"),$scope.count>0||($scope.CallMe(),$scope.count++)}}function sentimentCtrl($scope,pubsubService,dataManagerService,pip){$scope.courseID=-1,$scope.option={width:1200,height:600},pubsubService.onChangeCourse($scope,function(courseID){courseID>=0&&($scope.courseID=courseID,dataManagerService.getSentiment(courseID,function(data){$scope.sentimentData=data,$scope.sentimentData2=void 0,$scope.showGoBack=!1}))}),$scope.clickFunc=function(){$scope.sentimentData2=void 0},pip.onSentiment($scope,function(data){"delete"===data?($scope.showGoBack=!1,$scope.sentimentData2=void 0,console.log($scope.sentimentData2),$scope.$apply()):($scope.showGoBack=!0,console.log(data.days),dataManagerService.getSentimentDetails($scope.courseID,data.days,function(data){$scope.sentimentData2=data}))}),$scope.IntroOptions={steps:[{element:"#sentiment_id",intro:"This diagram shows what users discussed in the forum during the course period.            ",position:"left"}],showStepNumbers:!1,exitOnOverlayClick:!0,exitOnEsc:!0,nextLabel:"<strong>NEXT!</strong>",prevLabel:'<span style="color:green">Previous</span>',skipLabel:"Exit",doneLabel:"Thanks"},$scope.count=0,$scope.showTooltip=function(){$scope.count>0||($scope.CallMe(),$scope.count++)}}function temporalInfoCtrl($scope,pubsubService,dataManagerService){$scope.videoID=-1,$scope.courseID=-1,pubsubService.onChangeCourse($scope,function(courseID){$scope.courseID=courseID}),pubsubService.onChangeVideo($scope,function(videoInfo){$scope.videoID=videoInfo.videoId,dataManagerService.getDailyHotnessByVideo($scope.courseID,$scope.videoID,function(data){$scope.hotnessData=data})}),$scope.filterByDate=function(date){pubsubService.filterDate({startDate:date.getTime(),endDate:date.getTime()+6048e5})},$scope.IntroOptions={steps:[{element:"#calender_id",intro:"You can see how video popularity varies every day using this            calendar view. Each block represents a month while each unit means a day.",position:"left"}],showStepNumbers:!1,exitOnOverlayClick:!0,exitOnEsc:!0,nextLabel:"<strong>NEXT!</strong>",prevLabel:'<span style="color:green">Previous</span>',skipLabel:"Exit",doneLabel:"Thanks"},$scope.count=0,$scope.showTooltip=function(){console.log("called show tooltip"),$scope.count>0||($scope.CallMe(),$scope.count++)}}function videoListCtrl($scope,pubsubService,dataManagerService){function updateVideoList(courseID){dataManagerService.getVideoList(courseID,function(data){$scope.videoList=data,$(".introjs-helperLayer").remove(),$(".introjs-overlay").remove(),introJs().setOption("showStepNumbers","false"),introJs().start()})}$(".sidebartest").height($(window).height()-81),$scope.videoList=[],$scope.courseList=[],$scope.selectedVideoId=-1,$scope.selectedCourse=-1,$scope.$watch("selectedCourse.courseId",function(){$scope.selectedCourse.courseId&&(updateVideoList($scope.selectedCourse.courseId),pubsubService.changeCourse($scope.selectedCourse.courseId))}),$scope.setSelected=function(video){$scope.selectedVideoId=video.videoId,pubsubService.changeVideo(video),console.log(video)},dataManagerService.getCourseList(function(data){$scope.courseList=data}),$scope.IntroOptions={steps:[{element:"#step1",intro:"Please select your course here.",position:"right"}],showStepNumbers:!1,exitOnOverlayClick:!0,exitOnEsc:!0,nextLabel:"<strong>NEXT!</strong>",prevLabel:'<span style="color:green">Previous</span>',skipLabel:"Exit",doneLabel:"Thanks"},$scope.ShouldAutoStart=function(){return!0}}function videoPopInfoCtrl($scope,pubsubService,dataManagerService){$scope.courseID=-1,$scope.hotnessData=[],pubsubService.onChangeCourse($scope,function(courseID){$scope.courseId=courseID,dataManagerService.getHotness(courseID,function(data){$scope.courseID=courseID,$scope.data=[{key:"Hotness",values:data.map(function(d){return{label:d.videoId,value:d.pop,color:"#428bca"}})}]})}),$scope.options={chart:{type:"discreteBarChart",height:280,margin:{top:20,right:20,bottom:60,left:65},x:function(d){return d.label},y:function(d){return d.value},showValues:!0,valueFormat:function(d){return d3.format(",.1f")(d/1e3)+"k"},transitionDuration:500,xAxis:{axisLabel:"Video ID"},yAxis:{axisLabel:"Popularity (#user)",axisLabelDistance:20}}}}var ApplicationConfiguration=function(){var applicationModuleName="peekvisor",applicationModuleVendorDependencies=["ngResource","ngCookies","ngAnimate","ngTouch","ngSanitize","ui.router","ui.bootstrap","ui.utils","nvd3","mgcrea.ngStrap","ui.slider","ui.bootstrap.buttons","angular-intro"],registerModule=function(moduleName,dependencies){angular.module(moduleName,dependencies||[]),angular.module(applicationModuleName).requires.push(moduleName)};return{applicationModuleName:applicationModuleName,applicationModuleVendorDependencies:applicationModuleVendorDependencies,registerModule:registerModule}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).run(["$rootScope","$location","$window","$cookieStore",function($rootScope,$location,$window,$cookieStore){$rootScope.go=function(path,pageAnimationClass){$rootScope.pageAnimationClass="undefined"==typeof pageAnimationClass?"crossFade":pageAnimationClass,"back"===path?$window.history.back():$location.path(path)};var shotImg=["./img/empty.png","./img/empty.png","./img/empty.png","./img/empty.png","./img/empty.png","./img/empty.png"];$cookieStore.put("shotImg",shotImg)}]),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function($locationProvider){$locationProvider.hashPrefix("!")}]),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("peakanalysis");var siteRootPath=window.location.pathname;ApplicationConfiguration.registerModule("vismooc",["com.2fdevs.videogular","com.2fdevs.videogular.plugins.controls","com.2fdevs.videogular.plugins.overlayplay"]),videojs.options.flash.swf="./lib/vismoocjs/video-js.swf";var visMOOCApp=angular.module("vismooc"),colors=d3.scale.actionCategory();this.colors("seeked"),this.colors("pause"),this.colors("play"),this.colors("stalled"),this.colors("error"),this.colors("ratechange");var serviceID="communicationService",serviceData="dataManagerService";visMOOCApp.config(["$sceDelegateProvider",function($sceDelegateProvider){$sceDelegateProvider.resourceUrlWhitelist(["self","http://w02.hkvu.hk/edX/**","https://www.youtube.com**"])}]),angular.module("core").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/content"),$stateProvider.state("testview",{url:"/testview",templateUrl:"modules/core/views/testview.client.view.html"}).state("peak",{url:"/peak",templateUrl:"modules/core/views/home.client.view.html"})}]),angular.module("core").controller("HomeController",["$scope","$location","pip","$rootScope",function($scope,$location,pip,$rootScope){$scope.slideComponent=!1,$scope.goView=function(action){var nowURL=$location.path();"next"==action?-1!=nowURL.indexOf("graphmds")?$rootScope.go("/peak/flowmap","slideLeft"):-1!=nowURL.indexOf("flowmap")?$rootScope.go("/peak/parrellel","slideLeft"):-1!=nowURL.indexOf("parrellel")&&$rootScope.go("/peak/entrance","crossFade"):"prev"==action&&(-1!=nowURL.indexOf("graphmds")?$rootScope.go("/peak/entrance","crossFade"):-1!=nowURL.indexOf("flowmap")?$rootScope.go("/peak/graphmds","slideRight"):-1!=nowURL.indexOf("parrellel")&&$rootScope.go("/peak/flowmap","slideRight"))},pip.onSlideComponentChange($scope,function(data){"show"==data?$scope.slideComponent=!0:"hide"==data&&($scope.slideComponent=!1)})}]),angular.module("core").controller("LeftDockController",["$scope","$window","$http","$cookieStore",function($scope,$window,$http,$cookieStore){var initializeVideoList=function(){var docked=0;$("#dock li ul").height($(window).height()),$("#dock .dock-keleyi-com").click(function(){$(this).parent().parent().addClass("docked").removeClass("free"),docked+=1;var dockH=$(window).height()/docked,dockT=0;$("#dock li ul.docked").each(function(){$(this).height(dockH).css("top",dockT+"px"),dockT+=dockH}),$(this).parent().find(".undock").show(),$(this).hide(),docked>0?$("#content").css("margin-left","250px"):$("#content").css("margin-left","60px")}),$("#dock .undock").click(function(){$(this).parent().parent().addClass("free").removeClass("docked").animate({left:"-240px"},200).height($(window).height()).css("top","0px"),docked-=1;var dockH=$(window).height()/docked,dockT=0;$("#dock li ul.docked").each(function(){$(this).height(dockH).css("top",dockT+"px"),dockT+=dockH}),$(this).parent().find(".dock-keleyi-com").show(),$(this).hide(),docked>0?$("#content").css("margin-left","250px"):$("#content").css("margin-left","60px")}),$("#dock li").hover(function(){$(this).find("ul").animate({left:"30px"},400)},function(){$(this).find("ul.free").animate({left:"-240px"},400)})};initializeVideoList();var courseListObj=$cookieStore.get("courseListObj");if($scope.selectedCourse=$cookieStore.get("courseChoosed"),angular.isUndefined($scope.selectedCourse))$scope.selectedCourse=4;else{var cid=$scope.selectedCourse;$scope.courseDescription=courseListObj[cid].description,$scope.courseImgPath=courseListObj[cid].img,$scope.instructor=courseListObj[cid].instructor,$scope.courseList=$cookieStore.get("courseList")}console.log(siteRootPath+"getCourseList"),angular.isUndefined(courseListObj)&&$http.get(siteRootPath+"getCourseList").success(function(data){courseListObj={},angular.forEach(data,function(d){courseListObj[d.courseId]=d}),$cookieStore.put("courseListObj",courseListObj),$cookieStore.put("courseList",data),$scope.courseList=data,$cookieStore.put("courseChoosed",4),$scope.courseDescription=courseListObj[4].description,$scope.courseImgPath=courseListObj[4].img,$scope.instructor=courseListObj[4].instructor}),$scope.courseChange=function(){$cookieStore.put("courseChoosed",$scope.selectedCourse),$window.location.reload()}}]),angular.module("core").controller("PeakInfoController",["$scope","$location","pip","$rootScope","$http","$cookieStore",function($scope,$location,pip,$rootScope,$http,$cookieStore){var mainPath,getURL;mainPath=window.location.pathname;var selectedCourse=$cookieStore.get("courseChoosed");getURL=mainPath+"peakPreviewInfo?courseId="+selectedCourse,$http.get(getURL).success(function(data){$scope.peaks=data[0]})}]),angular.module("core").controller("PreviewController",["$scope","$location","pip","$rootScope","$cookieStore","$timeout","$http",function($scope,$location,pip,$rootScope,$cookieStore,$timeout,$http){var shotImg=$cookieStore.get("shotImg");$scope.showImg=shotImg.slice(shotImg.length-6,shotImg.length),pip.onShotImgChange($scope,function(canvas){var img=canvas.toDataURL("image/png");img=img.replace("data:image/png;base64,","");var finalImageSrc="data:image/png;base64,"+img;console.log(siteRootPath+"saveBase64Img"),$http.post(siteRootPath+"saveBase64Img",{image:img}).success(function(message){console.log(message)}),shotImg.push(finalImageSrc),$timeout(function(){$scope.showImg=shotImg.slice(shotImg.length-6,shotImg.length).reverse()},500)}),$scope.previewTo=function(which){"./img/empty.png"!=$scope.showImg[which]&&window.open($scope.showImg[which])}}]),angular.module("core").directive("peakImgHover",["$window","$location","pip",function($window,$location,pip){return{restrict:"A",link:function(scope,element,attrs){var nowURL,d3=$window.d3,hoverEle=d3.select(element[0]);hoverEle.on("mouseover",function(){nowURL=$location.path(),-1!=nowURL.indexOf("graph")?nowURL="graph":-1!=nowURL.indexOf("flowmap")&&(nowURL="flowmap"),"graph"==nowURL&&(d3.selectAll(".graphnode").style("opacity",.5),$("#graphmds_container .peak"+attrs.pid).css("opacity",1))}),hoverEle.on("mouseout",function(){nowURL=$location.path(),-1!=nowURL.indexOf("graph")?nowURL="graph":-1!=nowURL.indexOf("flowmap")&&(nowURL="flowmap"),"graph"==nowURL&&d3.selectAll(".graphnode").style("opacity",1)}),hoverEle.on("click",function(){nowURL=$location.path(),-1!=nowURL.indexOf("graph")?nowURL="graph":-1!=nowURL.indexOf("flowmap")&&(nowURL="flowmap"),"flowmap"==nowURL&&pip.emitFlowmapSlideChange(attrs.pid)})}}}]),angular.module("core").factory("pip",["$window","$rootScope",function($window,$rootScope){var SLIDECOMPONENT_MESSAGE="slideComponentChanged",SHOTIMG_MESSAGE="shotImgChanged",FLOWMAPSLIDE_MESSAGE="flowmapSlideChanged",SENTIMENT_MESSAGE="sentimentChanged",GRAPH_USERNAME_MESSAGE="graphUsernameChanged",CODE3_MESSAGE="code3Changed",emitSentiment=function(data){$rootScope.$broadcast(SENTIMENT_MESSAGE,data)},onSentiment=function(scope,callback){scope.$on(SENTIMENT_MESSAGE,function(event,data){callback(data)})},emitGraphUsername=function(data){$rootScope.$broadcast(GRAPH_USERNAME_MESSAGE,data)},onGraphUsername=function(scope,callback){scope.$on(GRAPH_USERNAME_MESSAGE,function(event,data){callback(data)})},emitCode3=function(data){$rootScope.$broadcast(CODE3_MESSAGE,data)},onCode3=function(scope,callback){scope.$on(CODE3_MESSAGE,function(event,data){callback(data)})},emitFlowmapSlideChange=function(data){$rootScope.$broadcast(FLOWMAPSLIDE_MESSAGE,data)},onFlowmapSlideChange=function(scope,callback){scope.$on(FLOWMAPSLIDE_MESSAGE,function(event,data){callback(data)})},emitShotImgChange=function(data){$rootScope.$broadcast(SHOTIMG_MESSAGE,data)},onShotImgChange=function(scope,callback){scope.$on(SHOTIMG_MESSAGE,function(event,data){callback(data)})},emitSlideComponentChange=function(data){$rootScope.$broadcast(SLIDECOMPONENT_MESSAGE,data)},onSlideComponentChange=function(scope,callback){scope.$on(SLIDECOMPONENT_MESSAGE,function(event,data){callback(data)})};return{emitSlideComponentChange:emitSlideComponentChange,onSlideComponentChange:onSlideComponentChange,emitShotImgChange:emitShotImgChange,onShotImgChange:onShotImgChange,emitFlowmapSlideChange:emitFlowmapSlideChange,onFlowmapSlideChange:onFlowmapSlideChange,emitSentiment:emitSentiment,onSentiment:onSentiment,emitGraphUsername:emitGraphUsername,onGraphUsername:onGraphUsername,emitCode3:emitCode3,onCode3:onCode3}}]),angular.module("peakanalysis").config(["$stateProvider",function($stateProvider){$stateProvider.state("peak.entrance",{url:"/entrance",templateUrl:"modules/peakanalysis/views/entrance.client.view.html"}).state("peak.parrellel",{url:"/parrellel",templateUrl:"modules/peakanalysis/views/parrellel.client.view.html",controller:"ParrellelController"}).state("peak.flowmap",{url:"/flowmap",templateUrl:"modules/peakanalysis/views/flowmap.client.view.html",controller:"FlowmapController"}).state("peak.flowmapGlyph",{url:"/flowmapGlyph",templateUrl:"modules/peakanalysis/views/flowmap.glyph.client.view.html",controller:"FlowmapController"}).state("peak.graph",{url:"/graph",templateUrl:"modules/peakanalysis/views/graph.client.view.html",controller:"GraphController"}).state("peak.graphmds",{url:"/graphmds",templateUrl:"modules/peakanalysis/views/graphmds.client.view.html",controller:"GraphmdsController"})}]),angular.module("peakanalysis").controller("EntranceController",["$scope","$window","$http","$location","$rootScope","pip","$modal","$cookieStore",function($scope,$window,$http,$location,$rootScope,pip,$modal,$cookieStore){pip.emitSlideComponentChange("hide");var courseId=$cookieStore.get("courseChoosed");angular.isUndefined(courseId)&&(courseId=4),4==courseId?$scope.courseName="JAVA":1==courseId&&($scope.courseName="NCH");var enterView=$location.search().v;angular.isUndefined(enterView)&&(enterView=0),$(".entrance_view_"+enterView).css("width","40%"),$scope.canvasURL="",$scope.shot=function(){html2canvas($("#test")).then(function(canvas){$scope.canvasURL=canvas.toDataURL()})}}]),angular.module("peakanalysis").controller("FlowmapController",["$scope","$window","$http","pip","$cookieStore","$location","dataManagerService","$timeout",function($scope,$window,$http,pip,$cookieStore,$location,dataManagerService,$timeout){pip.emitSlideComponentChange("show"),$scope.peakIndex=$location.search().pid,angular.isUndefined($scope.peakIndex)&&($scope.peakIndex=1);var mainPath,getURL;mainPath=window.location.pathname;var courseId=$cookieStore.get("courseChoosed");angular.isUndefined(courseId)&&(courseId=4),1==courseId?$scope.peakNum=35:4==courseId&&($scope.peakNum=34),pip.onFlowmapSlideChange($scope,function(data){$scope.peakIndex=data,$scope.filterChange()});var getServerData=function(peakIndex,callback){getURL=mainPath+"animationtest?peakIndex="+peakIndex+"&courseId="+courseId,$http.get(getURL).success(function(data){console.log(data),callback(data)})},callFunc=function(data){$scope.ClickAttackData=[],$scope.ClickAttackData.push(courseId),$scope.ClickAttackData.push(data)};$scope.filterChange=function(){var peakIndex=$scope.peakIndex;getServerData(peakIndex,callFunc)},getServerData($scope.peakIndex,callFunc),$("#peak_flowmap_chart").width($("#flowmap_container").width()+20),$scope.multiChartOptions={chart:{type:"lineChart",height:.2*$(".flowmap_container").height(),margin:{top:10,right:0,bottom:10,left:50},showControls:!1,x:function(d){return d.x},y:function(d){return d.y},useVoronoi:!1,clipEdge:!0,interpolate:"cardinal",transitionDuration:500,useInteractiveGuideline:!0,showLegend:!1,showXAxis:!1,xAxis:{showMaxMin:!1,tickFormat:function(d){var sec=d%60,min=Math.floor(d/60);return 0===sec&&(sec="00"),d3.time.format(min+"'"+sec+'"')}},yAxis:{tickFormat:function(d){return d}},fireClickEvent:function(e){$scope.currentTime=e.pointXValue,console.log($("#video")),$("#video")[0].childNodes[0].currentTime=Math.floor($scope.currentTime*($("#video")[0].childNodes[0].duration-5)/$("#video")[0].childNodes[0].duration+2)}}};var processData=function(data){console.log(data),data.clicks&&($scope.multiChartdata=[],data.clicks.forEach(function(dat){var length=dat.data.length,result=dat.data.slice(3,length-3).aggregate(3).map(function(dd,i){return{x:3*i,y:Math.floor(dd)}});("play"==dat.type||"pause"==dat.type)&&$scope.multiChartdata.push({key:dat.type,values:result,color:"#FE7E13"})}),angular.forEach($scope.multiChartdata[0].values,function(d,i){d.y+=$scope.multiChartdata[1].values[i].y}),$scope.multiChartdata.splice(1,1),$scope.multiChartdata[0].key="click")};dataManagerService.getActionCountInfo(4,"i4x-HKUSTx-COMP102x-video-34fa085d32834ea680d3f15267feeb05",processData),$scope.shot=function(){html2canvas($(".flowmap_whole")).then(function(canvas){pip.emitShotImgChange(canvas)})},$scope.autoplay=function(){var nowIndex=-1,timeCount=function(){return nowIndex+=1,nowIndex>=$scope.peakNum?($scope.peakIndex=0,void $scope.filterChange()):($scope.peakIndex=nowIndex,$scope.filterChange(),void $timeout(timeCount,500))};timeCount()}}]),angular.module("peakanalysis").controller("GraphController",["$window","$scope","$http","pip",function($window,$scope,$http,pip){pip.emitSlideComponentChange("show");var intersect=function(a,b){var t;return b.length>a.length&&(t=b,b=a,a=t),a.filter(function(e){for(var i=0,len=b.length;len>i;i++)if(e.name==b[i].name)return!0;return!1})},getSimilarity=function(arr1,arr2){var length=intersect(arr1,arr2).length;return length/(arr1.length+arr2.length-length)},getMyColor=function(_videoId,ColorArr){for(var nowObj,i=0;nowObj=ColorArr[i];i++)if(_videoId==nowObj.videoId)return nowObj.color;return null},weekNum=(d3.range(3,36,2),10),w=d3.scale.linear().range([30,60]),h=d3.scale.linear().range([30,45]);$http.post(siteRootPath+"getGlyphInfo",{}).success(function(data){console.log(data);var colors=[],usedcolors=0,nodes=[];data.forEach(function(d){var tmpNode={};tmpNode.name=d.week.toString()+"#"+d.currentTime.toString();var tmpcolor=getMyColor(d.videoId,colors);null!=tmpcolor?tmpNode.group=tmpcolor:(usedcolors++,colors.push({videoId:d.videoId,color:usedcolors}),tmpNode.group=usedcolors),nodes.push(tmpNode)}),console.log(nodes);for(var links=[],linkCount=[],i=0;i<data.length;i++)linkCount.push(0);for(var obj1,i=0;obj1=data[i];i++)for(var obj2,simTh=.2,j=i+1;obj2=data[j];j++){var sim=getSimilarity(obj1.peopleInfo,obj2.peopleInfo);if(sim>=simTh){var tmpLink={};tmpLink.source=i,tmpLink.target=j,tmpLink.strength=sim,links.push(tmpLink)}}w.domain(d3.extent(data,function(d){return d.peakWidth})),h.domain(d3.extent(data,function(d){return d.actionNum}));for(var peaks=data.map(function(d){for(var count,actionWidth=w(d.peakWidth)+20,actionHeight=h(d.actionNum)+20,actionPosition=d.currentTime/d.videoLength,videoWeekPosition=d.week/weekNum,line1Position=1-d.peopleInfo.length/d.actionNum,peopleInfo=d.peopleInfo.sort(function(a,b){return b.Count-a.Count}),nowCount=0,upLimit=Math.floor(.9*d.actionNum),i=0;(count=peopleInfo[i].Count)&&!(nowCount>=upLimit);i++)nowCount+=count;for(var line2Position=i/d.peopleInfo.length,countArr=[],sum=0,std=0,anomaly=0,i=0;i<d.peopleInfo.length;i++)countArr.push(d.peopleInfo[i].Count),sum+=d.peopleInfo[i].Count,d.peopleInfo[i].Count>10&&(anomaly+=d.peopleInfo[i].Count);anomaly/=sum;for(var average=sum/d.peopleInfo.length,i=0;i<d.peopleInfo.length;i++)std+=Math.sqrt((average-d.peopleInfo[i].Count)*(average-d.peopleInfo[i].Count));return std/=d.peopleInfo.length,{actionWidth:actionWidth,actionHeight:actionHeight,actionPosition:actionPosition,videoWeekPosition:videoWeekPosition,line1Position:line1Position,line2Position:line2Position,index:data.indexOf(d),ave:average,std:std,anomaly:anomaly}}),i=0;i<peaks.length;i++){var sum=data[i].grade.reduce(function(pv,cv){return pv+cv},0),w1=d3.scale.linear().range([.3*(peaks[i].actionWidth-20),1*(peaks[i].actionWidth-20)]),h1=d3.scale.linear().range([20-peaks[i].actionWidth,peaks[i].actionWidth-20]);w1.domain(d3.extent(peaks,function(d){return d.ave})),h1.domain(d3.extent(peaks,function(d){return d.std})),peaks[i].distrAve=w1(peaks[i].ave),peaks[i].distrStd=h1(peaks[i].std),peaks[i].grade=[];for(var j=0;j<data[i].grade.length;j++)peaks[i].grade.push(data[i].grade[j]/sum)}console.log(peaks);var finalData={nodes:nodes,links:links,peaks:peaks};$scope.peaks=peaks,$scope.$broadcast("forceData",finalData)}),$scope.shot=function(){console.log("start shot"),html2canvas($("#graph_container"),{useCORS:!0}).then(function(canvas){console.log("shot successfully"),pip.emitShotImgChange(canvas)})}}]),angular.module("peakanalysis").controller("GraphmdsController",["$window","$scope","$http","pip","$cookieStore",function($window,$scope,$http,pip,$cookieStore){pip.emitSlideComponentChange("show");var mainPath=window.location.pathname,intersect=function(a,b){var t;return b.length>a.length&&(t=b,b=a,a=t),a.filter(function(e){for(var i=0,len=b.length;len>i;i++)if(e.name==b[i].name)return!0;return!1})},getSimilarity=function(arr1,arr2){var length=intersect(arr1,arr2).length;return length/(arr1.length+arr2.length-length)},getMyColor=function(_videoId,ColorArr){for(var nowObj,i=0;nowObj=ColorArr[i];i++)if(_videoId==nowObj.videoId)return nowObj.color;return null},videoIdRange=d3.range(3,36,2),weekNum=10,w=d3.scale.linear().range([30,60]),h=d3.scale.linear().range([30,45]),courseId=$cookieStore.get("courseChoosed");angular.isUndefined(courseId)&&(courseId=4),$http.get(mainPath+"getGlyphInfo?courseId="+courseId).success(function(data){var colors=[],usedcolors=0,nodes=[];data.forEach(function(d){var tmpNode={},tmpcolor=getMyColor(d.videoId,colors);null!=tmpcolor?tmpNode.group=tmpcolor:(usedcolors++,colors.push({videoId:d.videoId,color:usedcolors}),tmpNode.group=usedcolors),nodes.push(tmpNode)});for(var links=[],linkCount=[],i=0;i<data.length;i++)linkCount.push(0);

var simMatrix=[];angular.forEach(d3.range(data.length),function(){simMatrix.push(d3.range(data.length))});for(var obj1,minSim=1,maxSim=0,i=0;obj1=data[i];i++){var simTh=.2;simMatrix[i][i]=1;for(var obj2,j=i+1;obj2=data[j];j++){var sim=getSimilarity(obj1.peopleInfo,obj2.peopleInfo);if(simMatrix[i][j]=simMatrix[j][i]=sim,minSim>sim&&(minSim=sim),sim>maxSim&&(maxSim=sim),sim>=simTh){var tmpLink={};tmpLink.source=i,tmpLink.target=j,tmpLink.strength=sim,links.push(tmpLink)}}}var fs=d3.scale.linear().range([1,0]).domain([minSim,maxSim]).clamp(!0);d3.range(data.length).forEach(function(row){d3.range(data.length).forEach(function(column){simMatrix[row][column]=fs(simMatrix[row][column])})});var coordinate=LG.utils.Mds.mds(simMatrix);w.domain(d3.extent(data,function(d){return d.peakWidth})),h.domain(d3.extent(data,function(d){return d.actionNum}));for(var peaks=data.map(function(d){var actionWidth=w(d.peakWidth)+20,actionHeight=h(d.actionNum)+20,actionPosition=d.currentTime/d.videoLength;if(1==courseId)var videoWeekPosition=videoIdRange.indexOf(d.videoId)/(videoIdRange.length-1);else if(4==courseId)var videoWeekPosition=d.week/weekNum;for(var count,line1Position=1-d.peopleInfo.length/d.actionNum,peopleInfo=d.peopleInfo.sort(function(a,b){return b.Count-a.Count}),nowCount=0,upLimit=Math.floor(.9*d.actionNum),i=0;(count=peopleInfo[i].Count)&&!(nowCount>=upLimit);i++)nowCount+=count;for(var line2Position=i/d.peopleInfo.length,countArr=[],sum=0,std=0,anomaly=0,i=0;i<d.peopleInfo.length;i++)countArr.push(d.peopleInfo[i].Count),sum+=d.peopleInfo[i].Count,d.peopleInfo[i].Count>10&&(anomaly+=d.peopleInfo[i].Count);anomaly/=sum;for(var average=sum/d.peopleInfo.length,i=0;i<d.peopleInfo.length;i++)std+=Math.sqrt((average-d.peopleInfo[i].Count)*(average-d.peopleInfo[i].Count));return std/=d.peopleInfo.length,{actionWidth:actionWidth,actionHeight:actionHeight,actionPosition:actionPosition,videoWeekPosition:videoWeekPosition,line1Position:line1Position,line2Position:line2Position,index:data.indexOf(d),ave:average,std:std,anomaly:anomaly}}),i=0;i<peaks.length;i++){var sum=data[i].grade.reduce(function(pv,cv){return pv+cv},0),w1=d3.scale.linear().range([.3*(peaks[i].actionWidth-20),1*(peaks[i].actionWidth-20)]),h1=d3.scale.linear().range([20-peaks[i].actionWidth,peaks[i].actionWidth-20]);w1.domain(d3.extent(peaks,function(d){return d.ave})),h1.domain(d3.extent(peaks,function(d){return d.std})),peaks[i].distrAve=w1(peaks[i].ave),peaks[i].distrStd=h1(peaks[i].std),peaks[i].grade=[];for(var j=0;j<data[i].grade.length;j++)peaks[i].grade.push(data[i].grade[j]/sum)}var finalData={nodes:nodes,links:links,peaks:peaks,coordinate:coordinate,peakBasicInfo:data};$scope.peaks=peaks,$scope.$broadcast("forceData",finalData)}),$scope.shot=function(){console.log("start shot"),html2canvas($("#graphmds_container"),{useCORS:!0}).then(function(canvas){console.log("shot successfully"),pip.emitShotImgChange(canvas)})}}]),angular.module("peakanalysis").controller("ParrellelController",["$scope","$window","$http","pip","$cookieStore",function($scope,$window,$http,pip,$cookieStore){pip.emitSlideComponentChange("show");var mainPath,getURL;mainPath=window.location.pathname;var courseId=$cookieStore.get("courseChoosed");angular.isUndefined(courseId)&&(courseId=4);var getServerData=function(callback){getURL=mainPath+"ParallelCoor?courseId="+courseId,console.log(getURL),$http.get(getURL).success(function(data){console.log("success"),console.log(data),callback(data)})},callFunc=function(data){for(var arr=[],peakNum=32,i=0;i<data.length;i++){for(var obj=data[i],numDistr=[],sum=0,j=0;peakNum>j;j++){var keyName="Peak"+j;obj[keyName]>0&&(numDistr.push(obj[keyName]),sum+=obj[keyName])}obj.activeness=sum>10?sum/numDistr.length:0,arr.push(obj)}$scope.PCData=[],$scope.PCData.push(courseId),$scope.PCData.push(arr)};getServerData(callFunc),$scope.shot=function(){html2canvas($("#parrellel_coordinate")).then(function(canvas){pip.emitShotImgChange(canvas)})}}]),angular.module("peakanalysis").controller("PeakModalController",["$scope","$window","$http","pip","$cookieStore","$location","dataManagerService","$rootScope",function($scope,$window,$http,pip,$cookieStore,$location,dataManagerService,$rootScope){$scope.courseId=$cookieStore.get("courseChoosed"),angular.isUndefined($scope.courseId)&&($scope.courseId=4),$scope.multiChartOptions={chart:{type:"lineChart",height:150,margin:{top:20,right:0,bottom:10,left:30},showControls:!1,x:function(d){return d.x},y:function(d){return d.y},useVoronoi:!1,clipEdge:!0,interpolate:"cardinal",transitionDuration:500,useInteractiveGuideline:!0,showLegend:!1,showXAxis:!1,xAxis:{showMaxMin:!1,tickFormat:function(d){var sec=d%60,min=Math.floor(d/60);return 0===sec&&(sec="00"),d3.time.format(min+"'"+sec+'"')}},yAxis:{tickFormat:function(d){return d}},fireClickEvent:function(e){$scope.currentTime=e.pointXValue,$("#video")[0].childNodes[0].currentTime=Math.floor($scope.currentTime*($("#video")[0].childNodes[0].duration-5)/$("#video")[0].childNodes[0].duration+2)}}};var processData=function(data){data.clicks&&($scope.multiChartdata=[],data.clicks.forEach(function(dat){var length=dat.data.length,result=dat.data.slice(3,length-3).aggregate(3).map(function(dd,i){return{x:3*i,y:Math.floor(dd)}});("play"==dat.type||"pause"==dat.type)&&$scope.multiChartdata.push({key:dat.type,values:result,color:"#FE7E13"})}),angular.forEach($scope.multiChartdata[0].values,function(d,i){d.y+=$scope.multiChartdata[1].values[i].y}),$scope.multiChartdata.splice(1,1),$scope.multiChartdata[0].key="click")};dataManagerService.getActionCountInfo($scope.courseId,$scope.peakInfo.videoId,processData),$scope.goFlowview=function(){$rootScope.go("/peak/flowmapGlyph","slideLeft"),$scope.$hide()}}]),angular.module("peakanalysis").directive("entranceHover",["$window",function($window){return{restrict:"A",link:function(scope,element,attrs){var d3=$window.d3,hoverEle=d3.select(element[0]);hoverEle.on("mouseover",function(){d3.selectAll(".entrance_view").style("width","5%"),hoverEle.style("width","40%"),$(".view_title h1").each(function(index,value){index==attrs.tid?$(value).fadeIn(1e3):$(value).css("display","none")}),$(".view_description p").each(function(index,value){index==attrs.tid?$(value).fadeIn(1e3):$(value).css("display","none")})})}}}]),angular.module("peakanalysis").directive("staticmap",function(){return{restrict:"EA",template:"",scope:{data:"="},link:function(scope,element){d3.select("#flowmapInput").on("change",function(){d3.select("#peakSelected").text(this.value)});var width=$(".peak_flowmap_container").width(),height=$(".peak_flowmap_container").height(),topheight=$(".peak_flowmap_map").height(),svg=d3.select(element[0]).append("svg").attr("width",width).attr("height",height).attr("opacity",.8);scope.$watch("data",function(data){function geoCoorCalculate(longitude,latitude){var coor={};return coor.x=(longitude+175)/360*w,coor.y=(75-latitude)/160*h,coor}console.log(data),svg.selectAll("*").remove();var courseId=data[0],dataTmp=data[1],w=width,h=topheight,timelinePos=.7*height;if(1==courseId)var dayTotal=60;else if(4==courseId)var dayTotal=74;for(var dayCount=[],i=0;dayTotal>i;i++)dayCount.push({click:0,people:0});for(var max=100,countryTop=["USA","CHN","GBR","CAN","DEU","BRA","ESP","AUS","FRA","IND","RUS"],countryMax={},j=0;j<countryTop.length;j++)countryMax[countryTop[j]]=[];for(var i=0;i<dataTmp.length;i++){var radius=Math.log(dataTmp[i].count/max*30);if(!(countryTop.indexOf(dataTmp[i].code3)<0)){countryMax[dataTmp[i].code3].push(dataTmp[i]),dayCount[dataTmp[i].day-1].people++,dayCount[dataTmp[i].day-1].click+=dataTmp[i].count,.1>radius&&(radius=.1);var t=.1,p1=geoCoorCalculate(dataTmp[i].longitude,dataTmp[i].latitude);"BRA"==dataTmp[i].code3&&(p1.y+=20);var p2={x:dataTmp[i].day/dayTotal*w,y:timelinePos-4},p3={x:.5*(p1.x+p2.x),y:h+.1*p1.x},cp1={x:p1.x,y:t*p1.y+(1-t)*p3.y},cp2={x:(1-t)*p1.x+t*p3.x,y:p3.y},cp3={x:t*p3.x+(1-t)*p2.x,y:p3.y},cp4={x:p2.x,y:(1-t)*p3.y+t*p2.y},pathStr="M"+p1.x+","+p1.y+" C"+cp1.x+","+cp1.y+" "+cp2.x+","+cp2.y+" "+p3.x+","+p3.y,path=svg.append("path").attr("d",pathStr).attr("stroke",function(){Math.floor(2*radius);return"#FE7E13"}).attr("stroke-width",2*radius).attr("fill","none").attr("opacity",.4);pathStr="M"+p3.x+","+p3.y+" C"+cp3.x+","+cp3.y+" "+cp4.x+","+cp4.y+" "+p2.x+","+p2.y,path=svg.append("path").attr("d",pathStr).attr("stroke",function(){Math.floor(2*radius);return"#FE7E13"}).attr("stroke-width",2*radius).attr("fill","none").attr("opacity",.4)}}if(1==courseId)var timeaxisScale=d3.time.scale().domain([new Date(2013,6,21,0,0,0),new Date(2013,8,16,0,0,0)]).rangeRound([0,width]);else if(4==courseId)var timeaxisScale=d3.time.scale().domain([new Date(2014,5,19,0,0,0),new Date(2014,8,2,0,0,0)]).rangeRound([0,width]);var xAxis=d3.svg.axis().scale(timeaxisScale).orient("top").tickFormat(d3.time.format("%b %d")).tickSize(0),axisSelector=svg.append("g").attr("class","axis").attr("transform","translate(0, "+timelinePos+")").call(xAxis);axisSelector.select("path").attr("fill","none").attr("stroke","#a9a9a9").attr("stroke-width","2").style("stroke-dasharray","2, 4").attr("shape-rendering","crispEdges").style("shape-rendering","crispEdges");for(var i=0;i<countryTop.length;i++){countryMax[countryTop[i]]=countryMax[countryTop[i]].sort(function(a,b){return b.count-a.count});var p={};countryMax[countryTop[i]].length>0&&(p=geoCoorCalculate(countryMax[countryTop[i]][0].longitude,countryMax[countryTop[i]][0].latitude),"BRA"==countryMax[countryTop[i]][0].code3&&(p.y+=30),radius=Math.log(countryMax[countryTop[i]][0].count/max*30),.1>radius&&(radius=.1),svg.append("circle").attr("r",8*radius).style("fill","#d73027").attr("cx",p.x).attr("cy",p.y).attr("opacity",.4)),countryMax[countryTop[i]].length>1&&(radius=Math.log(countryMax[countryTop[i]][1].count/max*30),.1>radius&&(radius=.1),svg.append("circle").attr("r",6*radius).style("fill","#FE7E13").attr("cx",p.x).attr("cy",p.y).attr("opacity",1))}for(var attackLinerange=d3.scale.linear().domain([0,dayCount.slice(0).sort(function(a,b){return b.click-a.click})[0].click]).range([0,.2*height]),i=0;dayTotal>i;i++)svg.append("line").attr("x1",(i+1)*width/dayTotal).attr("y1",timelinePos+4).attr("x2",(i+1)*width/dayTotal).attr("y2",timelinePos+attackLinerange(dayCount[i].click)+4).style("stroke","#FE7E13").attr("opacity",1).style("stroke-dasharray","8, 4").style("stroke-width",.5*width/dayTotal)})}}}),angular.module("peakanalysis").directive("map",function(){return{restrict:"EA",template:"",scope:{data:"="},link:function(scope,element){new Datamap({element:element[0],height:$(".peak_flowmap_map").height(),width:$(".peak_flowmap_map").width(),projection:"equirectangular",geographyConfig:{hideAntarctica:!1},fills:{defaultFill:"#ffffe5"}});scope.$watch("data",function(data){for(var dataTmp=data[1],countryCount=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],countryNames=["ARG","AUS","BRA","CAN","CHN","COL","FRA","DEU","GRC","HKG","IND","ITA","MEX","NLD","PHL","POL","ROU","RUS","SGP","ESP","UKR","GBR","USA"],i=0;i<dataTmp.length;i++)for(var j=0;j<countryNames.length;j++)countryNames[j]==dataTmp[i].code3&&(countryCount[j]+=dataTmp[i].count);console.log(countryCount);var color=d3.scale.linear().range(["#ffffe5","#41ab5d"]),max=d3.max(countryCount);color.domain([0,Math.log(max+1)]),console.log(max),d3.select(element[0]).selectAll(".datamaps-subunit").style("fill",function(d){return color(countryNames.indexOf(d.id)<0?0:Math.log(countryCount[countryNames.indexOf(d.id)]+1))}).style("stroke","#dddddd")})}}}),angular.module("peakanalysis").directive("peakGraph",["$window","$compile",function($window,$compile){return{restrict:"EA",scope:{},template:"<svg></svg>",link:function(scope,elem){var d3=$window.d3,rawSvg=elem.find("svg"),width=$("#graph_container").width(),height=$("#graph_container").height(),force=(d3.scale.category20(),d3.layout.force().size([width,height]).charge(-370).linkDistance(100)),svg=d3.select(rawSvg[0]).attr("width",width).attr("height",height);scope.$on("forceData",function(event,graph){scope.peaks=graph.peaks,force.nodes(graph.peaks).links(graph.links).linkStrength(function(d){return d.strength}).start();var link=svg.selectAll(".link").data(graph.links).enter().append("line").attr("stroke","#AEAEAE").attr("stroke-opacity",.6).attr("stroke-width",function(d){return 10*d.strength}),node=svg.selectAll(".node").data(graph.peaks).enter().append("g").attr("glyph","").attr("class","graphnode").attr("peak",function(d,i){return i}).call(force.drag).call(function(){$compile(this[0].parentNode)(scope)});node.append("title").text(function(d,i){return graph.nodes[i].name}),force.on("tick",function(){link.attr("x1",function(d){return d.source.x}).attr("y1",function(d){return d.source.y}).attr("x2",function(d){return d.target.x}).attr("y2",function(d){return d.target.y}),node.attr("transform",function(d){return"translate("+d.x+", "+d.y+")"})})})}}}]),angular.module("peakanalysis").directive("glyph",["$window",function($window){return{restrict:"EA",scope:!0,link:function(scope,element,attrs){var d3=$window.d3,rbWidth=20,rbHeight=20,plotSize=5,peak=scope.peaks[attrs.peak],width=peak.actionWidth,height=peak.actionHeight,rightBarRectPosition=(peak.line1Position,peak.line2Position,peak.videoWeekPosition),bottomBarRectPosition=peak.actionPosition,grade=peak.grade,anomaly=(peak.distrAve,peak.distrStd,peak.anomaly);33==peak.index&&(rightBarRectPosition+=.07);var barOffset=5,forlist=0,color=d3.scale.linear().range(["#fff7fb","#014636"]);color.domain([0,1]);var svg=d3.select(element[0]).attr("width",width).attr("height",height),rectWidth=width-rbWidth,rectHeight=height-rbHeight,rect=svg.append("g").attr("transform","translate(1, 1)");rect.append("rect").attr("width",rectWidth).attr("height",rectHeight).attr("x",-rectWidth/2+forlist).attr("y",-rectHeight/2).style("stroke","#251818").style("stroke-width",1).style("fill","none");for(var h=0,gradeColor=["#2DA464","#9CCF70","#DBE697","#FAE195","#F6986A","#DB453D"],i=0;i<grade.length;i++)h+=grade[i]*rectWidth,rect.append("rect").attr("x",rectWidth/2-h).attr("y",-rectHeight/2).attr("width",grade[i]*rectWidth).attr("height",rectHeight).style("fill",gradeColor[i]).style("stroke-width",0);rect.append("line").attr("x1",0-rectWidth/2).attr("y1",-anomaly*rectHeight+rectHeight/2).attr("x2",rectWidth/2).attr("y2",-anomaly*rectHeight+rectHeight/2).style("stroke","#000000").style("stoke-width",1);var rightBar=svg.append("g").attr("transform","translate(1, 1)");rightBar.append("line").attr("x1",rectWidth/2+barOffset).attr("y1",-rectHeight/2).attr("x2",rectWidth/2+barOffset).attr("y2",rectHeight/2).style("stroke","rgb(99,99,99)").style("stoke-width",1),rightBar.append("rect").attr("x",rectWidth/2+barOffset-plotSize/2).attr("y",rightBarRectPosition*rectHeight-rectWidth/2).attr("width",plotSize).attr("height",plotSize).style("fill","blue").style("stroke-width",0).style("fill-opacity",.8);var bottomBar=svg.append("g").attr("transform","translate(1,1)");bottomBar.append("line").attr("x1",-rectWidth/2).attr("y1",rectHeight/2+barOffset).attr("x2",rectWidth/2).attr("y2",rectHeight/2+barOffset).style("stroke","rgb(99,99,99)").style("stoke-width",1),bottomBar.append("rect").attr("x",bottomBarRectPosition*rectWidth-rectWidth/2).attr("y",rectHeight/2+barOffset-plotSize/2).attr("width",plotSize).attr("height",plotSize).style("fill","blue").style("stroke-width",0).style("fill-opacity",.8)}}}]),angular.module("peakanalysis").directive("graphmds",["$window","$compile","$modal",function($window,$compile,$modal){return{restrict:"EA",scope:{},template:"<svg></svg>",link:function(scope,element){var d3=$window.d3,rawSvg=element.find("svg"),outerWidth=$("#graphmds_container").width(),outerHeight=$("#graphmds_container").height(),margin={top:50,right:100,bottom:50,left:100},width=outerWidth-margin.left-margin.right,height=outerHeight-margin.top-margin.bottom,svg=d3.select(rawSvg[0]).attr("width",outerWidth).attr("height",outerHeight).append("g").attr("transform","translate("+margin.left+","+margin.top+")"),myModal=$modal({title:"My Title",content:"My Content",show:!1,template:"modules/peakanalysis/views/template/graph.glyph.modal.html",scope:scope});scope.showModal=function(){myModal.$promise.then(myModal.show)},scope.$on("forceData",function(event,graph){var coordinate=graph.coordinate,nodes=graph.nodes,peakBasicInfo=graph.peakBasicInfo;scope.peaks=graph.peaks;var peaks=graph.peaks,xdomain=d3.extent(coordinate,function(d){return d[0]}),ydomain=d3.extent(coordinate,function(d){return d[1]}),x=d3.scale.linear().range([0,width]).domain(xdomain),y=d3.scale.linear().range([0,height]).domain(ydomain);angular.forEach(coordinate,function(d){d[0]=x(d[0]),d[1]=y(d[1])}),preventOverlap(coordinate,35,30);var drawGlyph=function(glyph){glyph.selectAll(".node").data(peaks).enter().append("g").attr("transform",function(d,i){return"translate("+coordinate[i][0]+", "+coordinate[i][1]+")"}).attr("glyph","").attr("class",function(d,i){return"graphnode peak"+i}).attr("peak",function(d,i){return i}).on("click",function(d,i){var timeFrom=peakBasicInfo[i].currentTime,timeTo=peakBasicInfo[i].currentTime+peakBasicInfo[i].peakWidth;peakBasicInfo[i].fromTime=Math.floor(timeFrom/60)+"m"+timeFrom%60+"s",peakBasicInfo[i].toTime=Math.floor(timeTo/60)+"m"+timeTo%60+"s",scope.peakTitle="peak#"+i,scope.peakId=i,scope.peakInfo=peakBasicInfo[i],scope.showModal()}).append("title").text(function(d,i){return nodes[i].name}).call(function(){$compile(this[0].parentNode)(scope)})},drawEdge=function(){};svg.append("g").call(drawGlyph),svg.append("g").call(drawEdge)});var preventOverlap=function(coordinate,radius,times,rate){for(var t=void 0==times?3:times,overlaps=0,items=coordinate,count=0;t>count;){for(var i=0;i<items.length-1;i++)for(var j=i+1;j<items.length;j++){var dx=items[i][0]-items[j][0],dy=items[i][1]-items[j][1],dd=Math.sqrt(dx*dx+dy*dy);if(2*radius>dd){overlaps++;var l=radius-dd/2,xx=l*(dx/dd),yy=l*(dy/dd);items[i][0]=items[i][0]+xx,items[i][1]=items[i][1]+yy,items[j][0]=items[j][0]-xx,items[j][1]=items[j][1]-yy,overlaps++}}count++}}}}}]),angular.module("peakanalysis").directive("pcoords",function(){return{restrict:"EA",template:"",scope:{data:"="},link:function(scope,element){console.log(scope),console.log(element);var height=($(element.parent()).width(),$(element.parent()).height());scope.$watch("data",function(newValue,oldValue){if(newValue!=oldValue){var data=newValue,isDrawline=!1,courseId=data[0],dataTmp=data[1],dataSub=[],dataFiltered=[],fidelityLow=0;if(4==courseId)var peakInfo=[{videoId:"i4x-HKUSTx-COMP102x-video-b3fda93c4a834941833938476bb523a4",currentTime:90,duration:27,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-34fa085d32834ea680d3f15267feeb05",currentTime:258,duration:15,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-a08315fc6cf94115a87cf54eea25f8f4",currentTime:300,duration:30,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-77241c1ca2c04ed484a4fdf5b2be2b11",currentTime:120,duration:18,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-998df4d395ff49c3a28f2c412877b31b",currentTime:96,duration:30,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-15995d131e824f51829ed8fa7c66f0f3",currentTime:258,duration:24,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-a801c259109c4142af52627719d86276",currentTime:63,duration:27,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-dc84f1613615468ab4398116e65c44ec",currentTime:135,duration:48,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-41be73088c1f4ce9a49d1d6a1023c749",currentTime:132,duration:21,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-c4f82aa0be544e75972611ef2e38bdd9",currentTime:3,duration:27,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-9af430c237cc437ab0b79524dbad39b9",currentTime:132,duration:45,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-272c5ddf3090448a8c4ba6431a412dd3",currentTime:255,duration:30,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-9e3afc26c7a9476689520604916c5f30",currentTime:294,duration:30,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-202b44fa40e54f37a5a21ec9e4ec4c83",currentTime:177,duration:30,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-2f1a5bc4d3df4117b23ebf84ea0a1463",currentTime:168,duration:48,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-35ce36436c2b4b5abb4b9b94277f529f",currentTime:135,duration:48,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-48f450f9c4294c64a5fa84ae46464968",currentTime:57,duration:24,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-d48dbda9e97843108322c3305bc1c36e",currentTime:360,duration:36,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-9be6136b9b434652b7d7234f03c81c0f",currentTime:111,duration:21,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-2680e14cba5e43f488d9c9fc73e25cb9",currentTime:291,duration:30,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-d86629a449b04f60bc822939efc0e832",currentTime:387,duration:33,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-0d07c7ccf9ff48ce9dff58a59638138b",currentTime:6,duration:24,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-d96395769f254797bd02e23b27ab674b",currentTime:45,duration:27,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-4bbee764bc3c454e9d713c4671d76adc",currentTime:180,duration:36,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-efe9da4eec274da2b4e1604413d53569",currentTime:99,duration:21,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-345d0f4f55fa4cd3bf1dcce8a6235714",currentTime:171,duration:24,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-4e274308c82945eebe807be64e1e928d",currentTime:9,duration:27,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-a139188f9b2f4058be128f81b81a1731",currentTime:57,duration:21,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-677dc993a9ca4bada0216b8bb1931c69",currentTime:150,duration:30,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-c0172ef01c0b464cb74d099dec72f4a9",currentTime:141,duration:24,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-95a62e7a89434e708a97c3ff43ab9158",currentTime:270,duration:39,issubPeak:!1},{videoId:"i4x-HKUSTx-COMP102x-video-0db020fdd24d4928bbce21364445063b",currentTime:600,duration:39,issubPeak:!1}];else if(1==courseId)var peakInfo=[{videoId:3,currentTime:15,duration:21,issubPeak:!1},{videoId:5,currentTime:21,duration:6,issubPeak:!1},{videoId:5,currentTime:57,duration:9,issubPeak:!1},{videoId:3,currentTime:300,duration:9,issubPeak:!0},{videoId:3,currentTime:612,duration:24,issubPeak:!0},{videoId:7,currentTime:108,duration:66,issubPeak:!1},{videoId:7,currentTime:321,duration:69,issubPeak:!1},{videoId:7,currentTime:672,duration:48,issubPeak:!0},{videoId:9,currentTime:141,duration:21,issubPeak:!1},{videoId:9,currentTime:231,duration:39,issubPeak:!1},{videoId:9,currentTime:480,duration:42,issubPeak:!1},{videoId:9,currentTime:714,duration:36,issubPeak:!0},{videoId:11,currentTime:414,duration:24,issubPeak:!1},{videoId:11,currentTime:198,duration:39,issubPeak:!0},{videoId:13,currentTime:153,duration:18,issubPeak:!0},{videoId:13,currentTime:621,duration:24,issubPeak:!0},{videoId:13,currentTime:684,duration:42,issubPeak:!0},{videoId:15,currentTime:72,duration:24,issubPeak:!1},{videoId:15,currentTime:219,duration:18,issubPeak:!0},{videoId:15,currentTime:564,duration:75,issubPeak:!1},{videoId:17,currentTime:177,duration:12,issubPeak:!0},{videoId:17,currentTime:291,duration:18,issubPeak:!1},{videoId:19,currentTime:15,duration:24,issubPeak:!0},{videoId:21,currentTime:24,duration:12,issubPeak:!0},{videoId:21,currentTime:90,duration:21,issubPeak:!1},{videoId:21,currentTime:240,duration:6,issubPeak:!0},{videoId:21,currentTime:312,duration:9,issubPeak:!0},{videoId:23,currentTime:15,duration:18,issubPeak:!1},{videoId:23,currentTime:369,duration:18,issubPeak:!0},{videoId:23,currentTime:486,duration:18,issubPeak:!0},{videoId:25,currentTime:33,duration:21,issubPeak:!1},{videoId:25,currentTime:96,duration:12,issubPeak:!0},{videoId:25,currentTime:300,duration:12,issubPeak:!0},{videoId:27,currentTime:15,duration:18,issubPeak:!1},{videoId:27,currentTime:333,duration:33,issubPeak:!1},{videoId:27,currentTime:408,duration:24,issubPeak:!1},{videoId:29,currentTime:27,duration:24,issubPeak:!0},{videoId:29,currentTime:303,duration:63,issubPeak:!0},{videoId:33,currentTime:132,duration:21,issubPeak:!1},{videoId:33,currentTime:216,duration:24,issubPeak:!1},{videoId:35,currentTime:96,duration:12,issubPeak:!0}];for(var countryNames=["ARG","AUS","BRA","CAN","CHN","COL","FRA","DEU","GRC","HKG","IND","ITA","MEX","NLD","PHL","POL","ROU","RUS","SGP","ESP","UKR","GBR","USA"],i=0;i<dataTmp.length;i++){var obj={},seekCount=0,peakCount=0;if(obj.country=dataTmp[i].country,!(countryNames.indexOf(obj.country)<0)){obj.grade=dataTmp[i].grade,obj.droptime=0,obj.droptime=dataTmp[i].dropTime,4==courseId&&(obj.posts=dataTmp[i].forumposts,[obj.posts]>100&&(obj.posts=100)),obj.loyalty=0,obj.review=dataTmp[i].review,obj.delay=dataTmp[i].delay,obj.delay<0&&(obj.delay=0),obj.activeness=dataTmp[i].activeness,obj.activeness>10&&(obj.activeness=10);for(var droptime=0,j=0;j<peakInfo.length;j++){peakCount++;var axisKey="Peak"+j;dataTmp[i][axisKey]>0&&(seekCount++,droptime=peakCount),j>20||(obj[axisKey]=dataTmp[i][axisKey]<20?dataTmp[i][axisKey]:20)}obj.loyalty=seekCount,dataSub.push(obj)}}console.log(dataSub);var pc=d3.parcoords()(element[0]).data(dataSub).bundlingStrength(0).smoothness(0).bundleDimension("country").color("#FE7E13").alpha(.05).margin({top:24,left:20,bottom:12,right:0}).mode("queue").isDrawline(isDrawline).render(),axisKeys=Object.keys(pc.yscale);if(1==courseId)var attrAxesNum=7;else if(4==courseId)var attrAxesNum=8;for(var i=attrAxesNum;i<axisKeys.length;i++)pc.yscale[axisKeys[i]]=d3.scale.linear().domain([20.5,.5]).range([0,height-35]);pc.render().createAxes().reorderable().brushMode("1D-axes"),d3.select("#filterLow").on("change",function(){fidelityLow=this.value,d3.select("#lowerBound").text(this.value),dataFiltered=[];for(var axisKeys=Object.keys(pc.yscale),i=0;i<dataSub.length;i++){for(var obj={},j=0;7+fidelityLow>j;j++)obj[axisKeys[j]]=dataSub[i][axisKeys[j]];dataFiltered.push(obj)}d3.select("#total").text(dataFiltered.length),console.log(dataFiltered),pc.data(dataFiltered).createAxes().reorderable().brushMode("1D-axes").render()}),d3.select("#filterUp").on("change",function(){var opacity=this.value;d3.select("#upperBound").text(this.value),pc.alpha(opacity).render()}),d3.select("#changemodebutton").on("click",function(){console.log(isDrawline),isDrawline=!isDrawline,pc.isDrawline(isDrawline).render()}),d3.selectAll("path.domain").attr("fill","none").attr("stroke","#222").attr("stroke-width",1),d3.selectAll(".dimension .brush rect").attr("fill","transparent").attr("stroke","none").attr("stroke-width",0),d3.selectAll(".dimension .brush .extent").attr("fill","transparent").attr("stroke","#9E9E9E").attr("stroke-width",4)}})}}}),angular.module("vismooc").config(["$stateProvider",function($stateProvider){$stateProvider.state("content",{url:"/content",templateUrl:"modules/vismooc/views/content.client.view.html"})}]),visMOOCApp.controller("AnimationCtrl",["$scope",serviceID,serviceData,AnimationCtrl]);var contentBasedController=visMOOCApp.controller("contentBasedCtrl",["$scope",serviceID,serviceData,"$sce",contentBasedCtrl]);visMOOCApp.directive("currentVideoPlayTime",function(){return{controller:["$scope","$element",function($scope,$element){$scope.onTimeUpdate=function(){$scope.$apply(function(){$scope.currentPlayTime=$element[0].currentTime;var percentage=$element[0].currentTime/$element[0].duration*100;$("#timeProgressBar").css("width",percentage+"%")})}}],link:function(scope,ele){ele.bind("timeupdate",scope.onTimeUpdate)}}}),visMOOCApp.controller("courseInfoCtrl",["$scope",serviceID,serviceData,courseInfoCtrl]),visMOOCApp.controller("forumSocialNetwork",["$scope",serviceID,serviceData,"pip","$timeout",forumSocialNetwork]),visMOOCApp.controller("geographicInfoCtrl",["$scope",serviceID,serviceData,geographicInfoCtrl]),visMOOCApp.controller("sentimentCtrl",["$scope",serviceID,serviceData,"pip",sentimentCtrl]),visMOOCApp.controller("temporalInfoCtrl",["$scope",serviceID,serviceData,temporalInfoCtrl]),visMOOCApp.controller("videoListCtrl",["$scope",serviceID,serviceData,videoListCtrl]),visMOOCApp.controller("videoPopInfoCtrl",["$scope",serviceID,serviceData,videoPopInfoCtrl]),angular.module("vismooc").controller("vHomeCtrl",["$sce",function($sce){this.config={preload:"none",sources:[{src:$sce.trustAsResourceUrl("http://static.videogular.com/assets/videos/videogular.mp4"),type:"video/mp4"},{src:$sce.trustAsResourceUrl("http://static.videogular.com/assets/videos/videogular.webm"),type:"video/webm"},{src:$sce.trustAsResourceUrl("http://static.videogular.com/assets/videos/videogular.ogg"),type:"video/ogg"}],theme:{url:"http://www.videogular.com/styles/themes/default/latest/videogular.css"},plugins:{controls:{autoHide:!0,autoHideTime:5e3}}}}]),function(){visMOOCApp.directive("calenderView",[function(){return{restrict:"AE",scope:{data:"=",startDate:"=",endDate:"=",config:"=?",filterCallback:"=",callMe:"="},link:function(scope,element){var parser=function(data){for(var stats={},i=0;i<data.length;i++)stats[data[i].date/1e3]=data[i].value;return stats},startDateD=new Date(1*scope.startDate),endDateD=new Date(1*scope.endDate),range=endDateD.getMonth()-startDateD.getMonth()+1;range=Math.max(range,5);var data=parser(scope.data);console.log(data);var cal=new CalHeatMap;cal.init({data:data,itemSelector:element[0],start:startDateD,domain:"month",subDomain:"day",range:range,cellSize:20,onClick:function(date){scope.filterCallback(date)}}),data&&($(".introjs-helperLayer").remove(),$(".introjs-overlay").remove(),scope.callMe())}}}])}(),function(){visMOOCApp.directive("geoinfo",[function(){return{restrict:"AE",scope:{closeFunc:"=",data:"=",api:"=?",filterCallback:"=",config:"=?",callMe:"="},link:function(scope,element){for(var datas=scope.data,color=d3.scale.linear().range(["#edf8b1","#2c7fb8"]),codeArray=[],i=0;i<datas.length;i++)codeArray.push(datas[i].code3);var max=(new Datamap({element:element[0],height:280,width:700,fills:{defaultFill:"#edf8b1"},geographyConfig:{popupTemplate:function(geo){return['<div class="hoverinfo"><strong>',geo.properties.name+" : "+(codeArray.indexOf(geo.id)>0?datas[codeArray.indexOf(geo.id)].count:0),"</strong></div>"].join("")}}}),d3.max(datas.map(function(d){return d.count})));color.domain([0,Math.log(max)]),d3.select(element[0]).selectAll(".datamaps-subunit").style("fill",function(d){return color(codeArray.indexOf(d.id)<0?0:Math.log(datas[codeArray.indexOf(d.id)].count))}).style("stroke","#dddddd").on("click",function(d){console.log(d.id),scope.filterCallback(d.id)}),datas&&(console.log(scope.callMe),scope.callMe(),console.log("call tooltip"))}}}])}(),function(){visMOOCApp.directive("graph",["pip",function(pip){return{restrict:"AE",scope:{data:"=",option:"=",callMe:"=",threshold:"=",countrycode:"="},link:function(scope,element){var svg,xScale,yScale,widthScale,rScale,w,h,padding,drawGraph=function(){w=800,h=800,padding=100;var mappedNodes={};scope.data.nodes.forEach(function(d){mappedNodes[d.id]=d}),xScale=d3.scale.linear().domain([d3.min(scope.data.nodes,function(d){return d.x}),d3.max(scope.data.nodes,function(d){return d.x})]).range([padding,w-padding]),yScale=d3.scale.linear().domain([d3.min(scope.data.nodes,function(d){return d.x}),d3.max(scope.data.nodes,function(d){return d.x})]).range([padding,h-padding]),rScale=d3.scale.linear().domain([d3.min(scope.data.nodes,function(d){return d.size}),d3.max(scope.data.nodes,function(d){return d.size})]).range([2,11]),widthScale=d3.scale.linear().domain([d3.min(scope.data.edges,function(d){return d.size}),d3.max(scope.data.edges,function(d){return d.size})]).range([.1,4]),d3.select(element[0]).select("svg").length&&d3.select(element[0]).select("svg").remove(),svg=d3.select(element[0]).append("svg").attr("width",w).attr("height",h),svg.selectAll(".edge").data(scope.data.edges).enter().append("path").attr("class",function(d){var code=scope.countrycode;return"-"===code?"edge":code?mappedNodes[d.source].code3===code&&mappedNodes[d.target].code3===code?"edge":"opacityedge":"edge";

}).attr("d",function(d){var r=(xScale(mappedNodes[d.target].x)-xScale(mappedNodes[d.source].x))*(xScale(mappedNodes[d.target].x)-xScale(mappedNodes[d.source].x));r+=(yScale(mappedNodes[d.target].y)-yScale(mappedNodes[d.source].y))*(yScale(mappedNodes[d.target].y)-yScale(mappedNodes[d.source].y)),r=2*Math.sqrt(r);var path="M"+xScale(mappedNodes[d.source].x)+","+yScale(mappedNodes[d.source].y);return path=path+"A"+r+","+r+" 0 0 1",path=path+xScale(mappedNodes[d.target].x)+","+yScale(mappedNodes[d.target].y)}).style("fill","none").style("stroke-width",function(d){return widthScale(d.size)}).style("stroke",function(d){return d.color}),svg.selectAll(".node").data(scope.data.nodes).enter().append("circle").attr("class",function(d){var code=scope.countrycode;return"-"===code?"node":code?d.code3===code?"node":"opacitynode":"node"}).attr("cx",function(d){return xScale(d.x)}).attr("cy",function(d){return yScale(d.y)}).attr("r",function(d){return rScale(d.size)}).attr("fill",function(d){return"#CCC"===d.color?"#888":d.color}).on("mouseover",function(d){var selectedNodes=[];svg.selectAll(".edge").filter(function(dd){return dd.source==d.id||dd.target==d.id?(selectedNodes.push(dd.source),selectedNodes.push(dd.target),null):this}).attr("opacity","0.1"),svg.selectAll(".node").filter(function(dd){return selectedNodes.indexOf(dd.id)>=0?null:this}).attr("opacity","0.1"),d3.select(this).append("svg:title").append("class","hint").text(function(d){return d.code3})}).on("mouseout",function(){svg.selectAll(".edge").attr("opacity","1"),svg.selectAll(".node").attr("opacity","1")}).on("click",function(d){pip.emitGraphUsername([d.id,d.username])});var margin={left:50,top:50,right:30,buttom:20},legendWidth=200,legendHeight=20,legendGText=svg.append("g").attr("transform","translate("+margin.left+","+margin.top+")");legendGText.append("text").attr("x",40).attr("y",-5).text("Student's grade").attr("font-family","sans-serif").style("font-size","15px").attr("fill","black"),legendGText.append("text").attr("x",450).attr("y",-5).text("Student's activeness").attr("font-family","sans-serif").style("font-size","15px").attr("fill","black"),legendGText.append("text").attr("x",0).attr("y",legendHeight+15).text("15").attr("font-family","sans-serif").style("font-size","15px").attr("fill","black"),legendGText.append("text").attr("x",legendWidth-20).attr("y",legendHeight+15).text("100").attr("font-family","sans-serif").style("font-size","15px").attr("fill","black"),legendGText.append("text").attr("x",legendWidth+10).attr("y",legendHeight+15).text("No grade").attr("font-family","sans-serif").style("font-size","15px").attr("fill","black"),legendGText.append("text").attr("x",450).attr("y",legendHeight+15).text("less").attr("font-family","sans-serif").style("font-size","15px").attr("fill","black"),legendGText.append("text").attr("x",550).attr("y",legendHeight+15).text("more").attr("font-family","sans-serif").style("font-size","15px").attr("fill","black");var idGradient="gradient_id",legendG=svg.append("g").attr("transform","translate("+margin.left+","+margin.top+")");legendG.append("circle").attr("cx",460).attr("cy",legendHeight-10).attr("r",2).attr("fill","red"),legendG.append("circle").attr("cx",568).attr("cy",legendHeight-10).attr("r",11).attr("fill","red"),legendG.append("rect").attr("fill","black").attr("opacity",.4).attr("x",legendWidth+20).attr("y",0).attr("width",legendHeight).attr("height",legendHeight),legendG.append("defs").append("linearGradient").attr("id",idGradient).attr("x1","0%").attr("x2","100%").attr("y1","0%").attr("y2","0%"),legendG.append("rect").attr("fill","url(#"+idGradient+")").attr("x",0).attr("y",0).attr("width",legendWidth).attr("height",legendHeight).attr("rx",2).attr("ry",2);for(var theHue,rgbString,opacity,p,hueStart=160,hueEnd=0,numberHues=35,opacityStart=1,opacityEnd=1,deltaPercent=1/(numberHues-1),deltaHue=(hueEnd-hueStart)/(numberHues-1),deltaOpacity=(opacityEnd-opacityStart)/(numberHues-1),theData=[],i=0;numberHues>i;i++)theHue=hueStart+deltaHue*i,rgbString=d3.hsl(theHue,1,.6).toString(),opacity=opacityStart+deltaOpacity*i,p=0+deltaPercent*i,theData.push({rgb:rgbString,opacity:opacity,percent:p});var stops=d3.select("#"+idGradient).selectAll("stop").data(theData);stops.enter().append("stop"),stops.attr("offset",function(d){return d.percent}).attr("stop-color",function(d){return d.rgb}).attr("stop-opacity",function(d){return d.opacity}),scope.data&&($(".introjs-helperLayer").remove(),$(".introjs-overlay").remove(),scope.callMe())};scope.$watch("countrycode",function(data){data&&drawGraph()},!0),scope.$watch("data",function(data){data&&drawGraph()},!0)}}}])}(),function(){visMOOCApp.directive("graphgeo",["pip",function(pip){return{restrict:"AE",scope:{geodata:"=",selectedCountry:"="},link:function(scope,element){var drawWorldMap=function(){var height,width,datas=scope.geodata;height=element[0].offsetHeight,width=element[0].offsetWidth;for(var color=d3.scale.linear().range(["#edf8b1","#2c7fb8"]),codeArray=[],i=0;i<datas.length;i++)codeArray.push(datas[i].code3);var max=(new Datamap({element:element[0],height:height,width:width,fills:{defaultFill:"#edf8b1"},geographyConfig:{popupTemplate:function(geo){return['<div class="hoverinfo"><strong>',geo.properties.name+" : "+(codeArray.indexOf(geo.id)>0?datas[codeArray.indexOf(geo.id)].count:0),"</strong></div>"].join("")}}}),d3.max(datas.map(function(d){return d.count})));color.domain([0,Math.log(max)]),d3.select(element[0]).selectAll(".datamaps-subunit").style("fill",function(d){return color(codeArray.indexOf(d.id)<0?0:Math.log(datas[codeArray.indexOf(d.id)].count))}).style("stroke","#dddddd").on("click",function(d){console.log(d.id),pip.emitCode3(d.id)})};scope.$watch("geodata",function(data){data&&drawWorldMap()},!0)}}}])}(),function(){visMOOCApp.directive("heatmap",[function(){return{restrict:"AE",scope:{seekData:"=",config:"=?"},link:function(scope,element){var videoLength,height=element[0].offsetHeight,width=element[0].offsetWidth,initVideoLength=function(){videoLength=d3.max(scope.seekData,function(d){return+d.currentTime})},drawDensity=function(){initVideoLength();for(var heatmap=createWebGLHeatmap({canvas:element[0],intensityToAlpha:!0}),dataLength=scope.seekData.length,backwardNum=0,forwardNum=0,i=scope.seekData.length-1;i>=0;i--)scope.seekData[i].currentTime<scope.seekData[i].prevTime?backwardNum++:forwardNum++;for(var horiRatio=width/videoLength,precision=1,i=0;dataLength>i;i++)for(var interval=scope.seekData[i].currentTime-scope.seekData[i].prevTime,intervalAbs=Math.abs(interval),number=Math.ceil(intervalAbs/precision),intensity=0,size=12,j=0;number>j;j++){var tempX=(scope.seekData[i].prevTime+interval*j/number)*horiRatio,tempY=0;0>interval?(tempY=height/2+j/number*height/2,intensity=50/backwardNum):interval>0&&(tempY=j/number*height/2,intensity=50/forwardNum),heatmap.addPoint(tempX,tempY,size,intensity)}heatmap.update(),heatmap.display()};scope.api={initDraw:drawDensity},scope.$watch("seekData",function(data){data&&scope.api.initDraw()},!0)}}}])}(),function(){visMOOCApp.directive("seekline",[function(){return{restrict:"AE",scope:{seekDataPart:"=",seekData:"=",option:"=",videoLength:"=",callMe:"&"},link:function(scope,element){function exitIntro(targetElement){console.log(targetElement);var overlayLayer=targetElement.querySelector(".introjs-overlay");if(null!=overlayLayer){overlayLayer.style.opacity=0,setTimeout(function(){overlayLayer.parentNode&&overlayLayer.parentNode.removeChild(overlayLayer)},500);var helperLayer=targetElement.querySelector(".introjs-helperLayer");helperLayer&&helperLayer.parentNode.removeChild(helperLayer);var floatingElement=document.querySelector(".introjsFloatingElement");floatingElement&&floatingElement.parentNode.removeChild(floatingElement);var showElement=document.querySelector(".introjs-showElement");showElement&&(showElement.className=showElement.className.replace(/introjs-[a-zA-Z]+/g,"").replace(/^\s+|\s+$/g,""));var fixParents=document.querySelectorAll(".introjs-fixParent");if(fixParents&&fixParents.length>0)for(var i=fixParents.length-1;i>=0;i--)fixParents[i].className=fixParents[i].className.replace(/introjs-fixParent/g,"").replace(/^\s+|\s+$/g,"")}}var renderer,camera,scene,height=element[0].offsetHeight,width=element[0].offsetWidth;console.log(element.parent().width()),console.log($("#viscontent").css("width")),console.log(element.parent()[0].offsetWidth);var videoLength,clearCanvas=function(name){for(var count=scene.children.length,i=count-1;i>=0;i--)scene.children[i].name===name&&scene.remove(scene.children[i]);renderer.clear()},initVideoLength=(function(){renderer=new THREE.WebGLRenderer({canvas:element[0],alpha:!0,antialias:!0}),renderer.setSize(width,height),renderer.autoClear=!0,camera=new THREE.OrthographicCamera(width/-2,width/2,height/2,height/-2,1,1e3),camera.position.z=10,camera.lookAt(new THREE.Vector3(-0,-0,0)),scene=new THREE.Scene,clearCanvas()}(),function(){videoLength=scope.videoLength}),initData=function(input){var toUse={forward:[],backward:[]};initVideoLength();for(var toUseTemp=input,i=0;i<toUseTemp.length;i++){var temp=toUseTemp[i];temp.currentTime>temp.prevTime?toUse.forward.push(temp):toUse.backward.push(temp)}return toUse},defineMaterial=function(seek){var forward;forward=seek.currentTime-seek.prevTime>0?"forward":"not";var material;return"forward"==forward?(material=new THREE.LineBasicMaterial({color:16742400,linewidth:.6,opacity:.1}),material.transparent=!0):(material=new THREE.LineBasicMaterial({color:1260716,linewidth:1,opacity:.1}),material.transparent=!0),material},drawLine=function(dataToDraw){for(var lines=new THREE.Geometry,i=0;i<dataToDraw.length;i++){var temp=dataToDraw[i],x1=temp.prevTime/videoLength*width-width/2,x2=temp.currentTime/videoLength*width-width/2,y1=temp.prevTime>temp.currentTime?0:height/2,y2=temp.prevTime>temp.currentTime?-height/2:0;lines.vertices.push(new THREE.Vector3(x1,y1,0)),lines.vertices.push(new THREE.Vector3(x2,y2,0))}var line=new THREE.Line(lines,defineMaterial(dataToDraw[0]),THREE.LinePieces);line.name="line",scene.add(line),renderer.render(scene,camera)},drawAll=function(data){var toUse=initData(data);clearCanvas("line");for(var key in toUse)toUse.hasOwnProperty(key)&&toUse[key].length>0&&drawLine(toUse[key])};scope.api={initDraw:drawAll},scope.$watch("seekData",function(data){data&&(scope.api.initDraw(data),exitIntro(document),scope.callMe())},!0),scope.$watch("seekDataPart",function(data){data&&scope.api.initDraw(data)},!0)}}}])}(),function(){visMOOCApp.directive("sentiment",["pip",function(pip){return{restrict:"AE",scope:{sentimentData:"=",option:"=",callMe:"=",showGoBack:"="},link:function(scope,element){var svg,xScale,yScale,xAxis,yAxis,w,h,padding,xVar,mouseScale,getData=function(){return scope.sentimentData},setBackground=function(){xVar="timestamp",w=1200,h=600,padding=100,d3.select(element[0]).select("svg").length&&d3.select(element[0]).select("svg").remove();var formatTimeHour=d3.time.format("%H:%M"),formatTimeDay=d3.time.format("%B, %d"),formatMinutes=function(d){return scope.showGoBack?formatTimeHour(new Date(d)):formatTimeDay(new Date(d))};xScale=d3.scale.linear().domain(d3.extent(getData(),function(d){return d[xVar]})).range([padding,w-padding]),yScale=d3.scale.linear().domain([d3.max(getData(),function(d){return d.positive})+.1,d3.min(getData(),function(d){return d.positive})-.1]).range([padding,h-padding]),mouseScale=d3.scale.linear().domain(d3.extent(getData(),function(d){return d[xVar]})).range([padding+30,w-padding-250]),svg=d3.select(element[0]).append("svg").attr("width",w).attr("height",h),xAxis=d3.svg.axis().scale(xScale).orient("bottom").tickFormat(formatMinutes),yAxis=d3.svg.axis().scale(yScale).orient("left")},extendColorScale=function(positive,neutral){var tempScale=d3.scale.linear();return neutral>=.5?(tempScale.range(["#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a"]).domain([-.5,-.25,0,.25,.5]),tempScale(positive)):positive>=0?"rgba(102,189,99,"+(1-neutral)+")":"rgba(244,109,67,"+(1-neutral)+")"},extendYScale=function(yValue,positive,neutral){var tempScale=d3.scale.linear(),middle=h/2,one_third=padding+(h-2*padding)/3,two_thirds=h-padding-(h-2*padding)/3;return neutral>=.5?(tempScale.range([one_third,two_thirds]).domain([padding,h-padding]),tempScale(yValue)):positive>=0?(tempScale.range([padding,one_third]).domain([padding,middle]),tempScale(yValue)):(tempScale.range([two_thirds,h-padding]).domain([middle,h-padding]),tempScale(yValue))},setPlotSummary=function(){var summaryColor=function(positive){var tempScale=d3.scale.linear().range(["rgb(215,48,39)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(255,255,191)","rgb(217,239,139)","rgb(166,217,106)","rgb(102,189,99)","rgb(26,152,80)"]).domain([-.4,-.3,-.2,-.1,0,.1,.2,.3,.4]);return tempScale(positive)};svg.selectAll("circle").data(getData()).enter().append("circle").attr("class","sentimentNode").attr("cx",function(d){return xScale(d[xVar])}).attr("cy",function(d){return yScale(d.positive)}).attr("r",function(){return Math.sqrt(30)}).attr("stroke",function(){return"#aaa"}).attr("stroke-width",function(){return"1px"}).attr("fill",function(d){return summaryColor(d.positive)}).on("mouseover",function(d){d3.select(this).attr("fill","orange");var mouse=d3.mouse(this),xPosition=mouseScale(d[xVar]),yPosition=mouse[1];d3.select("#tooltip").style("left",xPosition+"px").style("top",yPosition+"px").select("#username").style("font-weight",900).style("color","#CCC").text(d.username),d3.select("#tooltip").style("left",xPosition+"px").style("top",yPosition+"px").select("#value").style("font-weight",900).style("color","red").text("The date is "+d.date),d3.select("#tooltip").style("left",xPosition+"px").style("top",yPosition+"px").select("#comment").text(d.text),d3.select("#tooltip").classed("hidden",!1)}).on("mouseout",function(){d3.select(this).attr("fill",function(d){return summaryColor(d.positive)}),d3.select("#tooltip").classed("hidden",!0)}).on("click",function(d){pip.emitSentiment(d)}),svg.append("g").attr("class","axis").attr("transform","translate(0,"+(h-padding)+")").call(xAxis),svg.append("g").attr("class","axis").attr("transform","translate("+padding+", 0 )").call(yAxis);var textG=svg.append("g").attr("class","axisText");textG.append("text").attr("x",w/2-100).attr("y",50).text("Sentiment trend").attr("font-family","sans-serif").style("font-size","30px").attr("fill","black"),textG.append("text").attr("x",w/2-120).attr("y",h-50).text("Date from the course started").attr("font-family","sans-serif").style("font-size","20px").attr("fill","black");var margin={left:900,top:80,right:30,buttom:20},legendWidth=200,legendHeight=20,idGradient="gradient_id_summary",legendG=svg.append("g").attr("transform","translate("+margin.left+","+margin.top+")");legendG.append("defs").append("linearGradient").attr("id",idGradient).attr("x1","0%").attr("x2","100%").attr("y1","0%").attr("y2","0%"),legendG.append("rect").attr("fill","url('#"+idGradient+"')").attr("x",0).attr("y",0).attr("width",legendWidth).attr("height",legendHeight).attr("rx",2).attr("ry",2);var theData=["rgb(215,48,39)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(255,255,191)","rgb(217,239,139)","rgb(166,217,106)","rgb(102,189,99)","rgb(26,152,80)"],stops=d3.select("#"+idGradient).selectAll("stop").data(theData);stops.enter().append("stop"),stops.attr("offset",function(d,i){return.125*i}).attr("stop-color",function(d){return d}),legendG.append("text").attr("x",-30).attr("y",legendHeight+20).text("negative").attr("font-family","sans-serif").style("font-size","15px").attr("fill","black"),legendG.append("text").attr("x",legendWidth-20).attr("y",legendHeight+20).text("positive").attr("font-family","sans-serif").style("font-size","15px").attr("fill","black")},setPlotDetail=function(){var one_third=(h-2*padding)/3;svg.append("rect").attr("x",padding).attr("y",padding).attr("width",w-2*padding).attr("height",one_third).attr("fill","rgba(204,235,197, 0.5)"),svg.append("rect").attr("x",padding).attr("y",one_third+padding).attr("width",w-2*padding).attr("height",one_third).attr("fill","rgba(255,255,204, 0.5)"),svg.append("rect").attr("x",padding).attr("y",one_third+padding+one_third).attr("width",w-2*padding).attr("height",one_third).attr("fill","rgba(253,218,236, 0.5)"),svg.selectAll("circle").data(getData()).enter().append("circle").attr("class","sentimentNode").attr("cx",function(d){return xScale(d[xVar])}).attr("cy",function(d){return extendYScale(yScale(d.positive),d.positive,d.neutral)}).attr("r",function(){return Math.sqrt(30)}).attr("stroke",function(){return"#aaa"}).attr("stroke-width",function(){return"1px"}).attr("fill",function(d){return d.grade?"#CCC"===d.grade?"#888":d.grade:extendColorScale(d.positive,d.neutral)}).on("mouseover",function(d){d3.select(this).attr("fill","orange");var mouse=d3.mouse(this);console.log(mouse);var xPosition=mouseScale(d[xVar]),yPosition=mouse[1];d3.select("#tooltip").style("left",xPosition+"px").style("top",yPosition+"px").select("#username").style("font-weight",900).style("color","#CCC").text(d.username),d3.select("#tooltip").style("left",xPosition+"px").style("top",yPosition+"px").select("#value").style("font-weight",900).style("color","red").text("The date is "+d.date),d3.select("#tooltip").style("left",xPosition+"px").style("top",yPosition+"px").select("#comment").text(d.text),d3.select("#tooltip").classed("hidden",!1)}).on("mouseout",function(){d3.select(this).attr("fill",function(d){return d.grade?"#CCC"===d.grade?"#888":d.grade:extendColorScale(d.positive,d.neutral)}),d3.select("#tooltip").classed("hidden",!0)}).on("click",function(d){scope.showGoBack||pip.emitSentiment(d)}),svg.append("g").attr("class","axis").attr("transform","translate(0,"+(h-padding)+")").call(xAxis);var textG=svg.append("g").attr("class","axisText");textG.append("text").attr("class","goBackLink").attr("x",50).attr("y",50).attr("font-family","sans-serif").style("font-size","15px").attr("fill","black").append("tspan").attr("text-decoration","underline").text("Go Back To Summary").on("click",function(){pip.emitSentiment("delete")}),textG.append("text").attr("x",w/2-70).attr("y",h-50).text("Time of a day").attr("font-family","sans-serif").style("font-size","20px").attr("fill","black"),textG.append("text").attr("y",70).attr("x",-200).attr("dy",".31em").attr("transform","rotate(-90)").text("Appreciation").attr("font-family","sans-serif").style("font-size","16px").attr("fill","black"),textG.append("text").attr("y",70).attr("x",-320).attr("dy",".31em").attr("transform","rotate(-90)").text("Neutral").attr("font-family","sans-serif").style("font-size","16px").attr("fill","black"),textG.append("text").attr("y",70).attr("x",-460).attr("dy",".31em").attr("transform","rotate(-90)").text("Questions").attr("font-family","sans-serif").style("font-size","16px").attr("fill","black");var margin={left:800,top:50,right:30,buttom:20},legendWidth=200,legendHeight=20,legendGText=svg.append("g").attr("transform","translate("+margin.left+","+margin.top+")");legendGText.append("text").attr("x",40).attr("y",-5).text("Student's grade").attr("font-family","sans-serif").style("font-size","15px").attr("fill","black"),legendGText.append("text").attr("x",0).attr("y",legendHeight+15).text("15").attr("font-family","sans-serif").style("font-size","15px").attr("fill","black"),legendGText.append("text").attr("x",legendWidth-20).attr("y",legendHeight+15).text("100").attr("font-family","sans-serif").style("font-size","15px").attr("fill","black"),legendGText.append("text").attr("x",legendWidth+10).attr("y",legendHeight+15).text("No grade").attr("font-family","sans-serif").style("font-size","15px").attr("fill","black");var idGradient="gradient_id_grade",legendG=svg.append("g").attr("transform","translate("+margin.left+","+margin.top+")");legendG.append("rect").attr("fill","black").attr("opacity",.4).attr("x",legendWidth+20).attr("y",0).attr("width",legendHeight).attr("height",legendHeight),legendG.append("defs").append("linearGradient").attr("id",idGradient).attr("x1","0%").attr("x2","100%").attr("y1","0%").attr("y2","0%"),legendG.append("rect").attr("fill","url('#"+idGradient+"')").attr("x",0).attr("y",0).attr("width",legendWidth).attr("height",legendHeight).attr("rx",2).attr("ry",2);var theData=["rgb(215,48,39)","rgb(244,109,67)","rgb(253,174,97)","rgb(254,224,139)","rgb(255,255,191)","rgb(217,239,139)","rgb(166,217,106)","rgb(102,189,99)","rgb(26,152,80)"],stops=d3.select("#"+idGradient).selectAll("stop").data(theData.reverse());stops.enter().append("stop"),stops.attr("offset",function(d,i){return.125*i}).attr("stop-color",function(d){return d})};scope.sentimentData&&($(".introjs-helperLayer").remove(),$(".introjs-overlay").remove(),scope.callMe()),scope.$watch("sentimentData",function(data){data&&console.log("sentimentData changed"),setBackground(),scope.showGoBack?setPlotDetail():setPlotSummary()},!0)}}}])}(),function(){visMOOCApp.directive("wordcloud",["pip",function(){return{restrict:"AE",scope:{wordCloudData:"="},link:function(scope,element){var data,canvas,sizeScale,drawWordcloud=function(){if(sizeScale=d3.scale.linear().range([13,80]),scope.wordCloudData){data=scope.wordCloudData;var min=d3.min(data,function(d){return d[1]}),max=d3.max(data,function(d){return d[1]});sizeScale.domain([min,max]);for(var i=0;i<data.length;i++){var ele=data[i];ele[1]=sizeScale(ele[1])}}var height=element[0].offsetHeight,width=element[0].offsetWidth;d3.select(element[0]).select("canvas").length&&d3.select(element[0]).select("canvas").remove(),canvas=d3.select(element[0]).append("canvas").attr("id","wordcloudCanvas").attr("width",width).attr("height",height),WordCloud(document.getElementById("wordcloudCanvas"),{list:data})};scope.$watch("wordCloudData",function(data){data&&(console.log("enter"),drawWordcloud())},!0)}}}])}(),function(){function pubsubService($rootScope){var CHANGE_COURSE="changeCourse",CHANGE_VIDEO="changeVideo",FILTER_COUNTRY="filterCountry",FILTER_DATE="filterDate",changeCourse=function(courseID){$rootScope.$broadcast(CHANGE_COURSE,courseID)},onChangeCourse=function($scope,handler){$scope.$on(CHANGE_COURSE,function(event,message){handler(message)})},changeVideo=function(videoID){$rootScope.$broadcast(CHANGE_VIDEO,videoID)},onChangeVideo=function($scope,handler){$scope.$on(CHANGE_VIDEO,function(event,message){handler(message)})},filterCountry=function(countryID){$rootScope.$broadcast(FILTER_COUNTRY,countryID)},onFilterCountry=function($scope,handler){$scope.$on(FILTER_COUNTRY,function(event,message){handler(message)})},filterDate=function(period){$rootScope.$broadcast(FILTER_DATE,period)},onFilterDate=function($scope,handler){$scope.$on(FILTER_DATE,function(event,message){handler(message)})};return{changeCourse:changeCourse,onChangeCourse:onChangeCourse,changeVideo:changeVideo,onChangeVideo:onChangeVideo,filterCountry:filterCountry,onFilterCountry:onFilterCountry,filterDate:filterDate,onFilterDate:onFilterDate}}var serviceID="communicationService";visMOOCApp.factory(serviceID,["$rootScope",pubsubService])}(),function(){function dataManagerServiceFun($http){var dataFactory={},mainPath=window.location.pathname;return dataFactory.getSentiment=function(courseId,callback){var tmpURL=mainPath+"getSentiment?courseId="+courseId;$http.get(tmpURL).success(function(data){callback(data)})},dataFactory.getWordCloudData=function(courseId,userId,callback){var tmpURL=mainPath+"getWordCloudData?courseId="+courseId+"&userId="+userId;console.log(userId),$http.get(tmpURL).success(function(data){callback(data)})},dataFactory.getWordCloudDataByGeo=function(courseId,code3,callback){var tmpURL=mainPath+"getWordCloudDataByGeo?courseId="+courseId+"&countryCode="+code3;console.log(code3),$http.get(tmpURL).success(function(data){callback(data)})},dataFactory.getSentimentDetails=function(courseId,days,callback){var tmpURL=mainPath+"getSentimentDetails?courseId="+courseId+"&days="+days;$http.get(tmpURL).success(function(data){callback(data)})},dataFactory.getForumSocialNetwork=function(courseId,filterLevel,callback){0===filterLevel||filterLevel||(filterLevel=0);var tmpURL=mainPath+"modules/vismooc/data/graph/"+courseId+"-"+filterLevel+".json";$http.get(tmpURL).success(function(data){callback(data)})},dataFactory.getActionCountInfo=function(courseId,videoId,callback){var tmpURL=mainPath+"getContentBasedData?type=action&courseId="+courseId+"&videoId="+videoId;$http.get(tmpURL).success(function(data){callback(data)})},dataFactory.getSeekInfo=function(courseId,videoId,callback){var tmpURL=mainPath+"getContentBasedData?type=seek&courseId="+courseId+"&videoId="+videoId;$http.get(tmpURL).success(function(data){callback(data)})},dataFactory.getActionCountInfoByCountry=function(courseId,videoId,country,callback){var tmpURL=mainPath+"getContentBasedData?type=action&courseId="+courseId+"&videoId="+videoId+"&country="+country;$http.get(tmpURL).success(function(data){callback(data)})},dataFactory.getSeekInfoByCountry=function(courseId,videoId,country,callback){var tmpURL=mainPath+"getContentBasedData?type=seek&courseId="+courseId+"&videoId="+videoId+"&country="+country;$http.get(tmpURL).success(function(data){callback(data)})},dataFactory.getActionCountInfoByTime=function(courseId,videoId,start,end,callback){var tmpURL=mainPath+"getContentBasedData?type=action&courseId="+courseId+"&videoId="+videoId+"&startTime="+start+"&endTime="+end;$http.get(tmpURL).success(function(data){callback(data)})},dataFactory.getSeekInfoByTime=function(courseId,videoId,start,end,callback){var tmpURL=mainPath+"getContentBasedData?type=seek&courseId="+courseId+"&videoId="+videoId+"&startTime="+start+"&endTime="+end;$http.get(tmpURL).success(function(data){callback(data)})},dataFactory.getDailyHotnessByVideo=function(courseId,videoId,callback){var tmpURL=mainPath+"getVideoPop?courseId="+courseId+"&videoId="+videoId;$http.get(tmpURL).success(function(data){callback(data)})},dataFactory.getDemographicData=function(courseId,callback){var tmpURL=mainPath+"getDemographicData?courseId="+courseId;$http.get(tmpURL).success(function(data){callback(data)})},dataFactory.getCourseInfo=function(courseId,callback){var tmpURL=mainPath+"getCourseInfo?courseId="+courseId;$http.get(tmpURL).success(function(data){callback(data)})},dataFactory.getCourseList=function(callback){var tmpURL=mainPath+"getCourseList";$http.get(tmpURL).success(function(data){callback(data)})},dataFactory.getHotness=function(courseId,callback){var tmpURL=mainPath+"getHotness?courseId="+courseId;$http.get(tmpURL).success(function(data){callback(data)})},dataFactory.getVideoList=function(courseId,callback){var tmpURL=mainPath+"getVideoList?courseId="+courseId;$http.get(tmpURL).success(function(data){data.forEach(function(week){week.videos.forEach(function(video){video.videoSource?"http"===video.videoSource.substring(0,4)||(video.videoSource=video.videoSource):video.videoSource=""})}),callback(data)})},dataFactory}var serviceData="dataManagerService";visMOOCApp.factory(serviceData,["$http",dataManagerServiceFun])}();